5b980f4b332165d1ab32d72bfdcc5b9f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const testing_1 = require("@nestjs/testing");
const axios_1 = require("@nestjs/axios");
const core_config_1 = require("@visapi/core-config");
const slack_service_1 = require("./slack.service");
const rxjs_1 = require("rxjs");
describe('SlackService', () => {
    let service;
    let httpService;
    let configService;
    let logger;
    const mockHttpService = {
        post: jest.fn(),
    };
    const mockConfigService = {
        get slackEnabled() { return true; },
        get slackWebhookUrl() { return 'https://hooks.slack.com/services/test/webhook'; },
        get slackDefaultChannel() { return '#alerts'; },
        get slackSigningSecret() { return 'test-secret'; },
    };
    const mockLogger = {
        debug: jest.fn(),
        info: jest.fn(),
        error: jest.fn(),
        warn: jest.fn(),
    };
    beforeEach(() => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        const module = yield testing_1.Test.createTestingModule({
            providers: [
                slack_service_1.SlackService,
                {
                    provide: axios_1.HttpService,
                    useValue: mockHttpService,
                },
                {
                    provide: core_config_1.ConfigService,
                    useValue: mockConfigService,
                },
                {
                    provide: `PinoLogger:${slack_service_1.SlackService.name}`,
                    useValue: mockLogger,
                },
            ],
        }).compile();
        service = module.get(slack_service_1.SlackService);
        httpService = module.get(axios_1.HttpService);
        configService = module.get(core_config_1.ConfigService);
        logger = module.get(`PinoLogger:${slack_service_1.SlackService.name}`);
    }));
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('sendGrafanaAlert', () => {
        const mockPayload = {
            dashboardId: 1,
            evalMatches: [
                {
                    value: 75.5,
                    metric: 'cpu_usage',
                    tags: { host: 'server-1' },
                },
            ],
            message: 'CPU usage is above threshold',
            orgId: 1,
            panelId: 2,
            ruleId: 3,
            ruleName: 'High CPU Usage',
            ruleUrl: 'https://grafana.example.com/d/dashboard/panel',
            state: 'alerting',
            tags: { severity: 'high' },
            title: 'High CPU Usage Alert',
        };
        it('should send Grafana alert successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)({ data: { ok: true } }));
            yield service.sendGrafanaAlert(mockPayload);
            expect(mockHttpService.post).toHaveBeenCalledWith('https://hooks.slack.com/services/test/webhook', expect.objectContaining({
                channel: '#alerts',
                username: 'VisAPI Monitoring',
                icon_emoji: ':chart_with_upwards_trend:',
                text: expect.stringContaining('ALERTING'),
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'danger',
                        title: 'High CPU Usage',
                        title_link: 'https://grafana.example.com/d/dashboard/panel',
                        text: 'CPU usage is above threshold',
                    }),
                ]),
            }), expect.objectContaining({
                headers: {
                    'Content-Type': 'application/json',
                },
                timeout: 10000,
            }));
            expect(mockLogger.info).toHaveBeenCalledWith('Slack alert sent successfully', expect.objectContaining({
                ruleName: 'High CPU Usage',
                state: 'alerting',
            }));
        }));
        it('should skip alert when Slack is disabled', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            Object.defineProperty(configService, 'slackEnabled', {
                get: jest.fn().mockReturnValue(false),
            });
            yield service.sendGrafanaAlert(mockPayload);
            expect(mockHttpService.post).not.toHaveBeenCalled();
            expect(mockLogger.debug).toHaveBeenCalledWith('Slack integration disabled, skipping alert');
        }));
        it('should handle missing webhook URL', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            Object.defineProperty(configService, 'slackWebhookUrl', {
                get: jest.fn().mockReturnValue(''),
            });
            yield service.sendGrafanaAlert(mockPayload);
            expect(mockHttpService.post).not.toHaveBeenCalled();
            expect(mockLogger.error).toHaveBeenCalledWith('Slack webhook URL not configured');
        }));
        it('should handle HTTP errors', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const error = new Error('Network error');
            mockHttpService.post.mockImplementation(() => {
                throw error;
            });
            yield expect(service.sendGrafanaAlert(mockPayload)).rejects.toThrow('Network error');
            expect(mockLogger.error).toHaveBeenCalledWith('Failed to send Slack alert', expect.objectContaining({
                error: 'Network error',
                ruleName: 'High CPU Usage',
                state: 'alerting',
            }));
        }));
        it('should format resolved alert correctly', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const resolvedPayload = Object.assign(Object.assign({}, mockPayload), { state: 'ok', message: 'CPU usage is back to normal' });
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)({ data: { ok: true } }));
            yield service.sendGrafanaAlert(resolvedPayload);
            expect(mockHttpService.post).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
                text: expect.stringContaining('OK'),
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'good',
                        pretext: expect.stringContaining('OK Alert'),
                    }),
                ]),
            }), expect.any(Object));
        }));
    });
    describe('sendCustomAlert', () => {
        it('should send custom alert successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)({ data: { ok: true } }));
            yield service.sendCustomAlert('Test message', 'warning', '#test');
            expect(mockHttpService.post).toHaveBeenCalledWith('https://hooks.slack.com/services/test/webhook', expect.objectContaining({
                channel: '#test',
                username: 'VisAPI System',
                icon_emoji: ':robot_face:',
                text: ':warning: Test message',
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'warning',
                        text: 'Test message',
                    }),
                ]),
            }), expect.objectContaining({
                headers: {
                    'Content-Type': 'application/json',
                },
                timeout: 10000,
            }));
            expect(mockLogger.info).toHaveBeenCalledWith('Custom Slack alert sent successfully', expect.objectContaining({
                severity: 'warning',
                channel: '#test',
            }));
        }));
        it('should use default channel when none specified', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            mockHttpService.post.mockReturnValue((0, rxjs_1.of)({ data: { ok: true } }));
            yield service.sendCustomAlert('Test message');
            expect(mockHttpService.post).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
                channel: '#alerts',
            }), expect.any(Object));
        }));
    });
    describe('validateWebhookSignature', () => {
        it('should return true for valid signature', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const payload = '{"test": "data"}';
            const timestamp = '1234567890';
            const crypto = require('crypto');
            const signature = 'v0=' + crypto
                .createHmac('sha256', 'test-secret')
                .update(`v0:${timestamp}:${payload}`)
                .digest('hex');
            const result = yield service.validateWebhookSignature(payload, timestamp, signature);
            expect(result).toBe(true);
        }));
        it('should return false for invalid signature', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const payload = '{"test": "data"}';
            const timestamp = '1234567890';
            const signature = 'v0=invalid_signature';
            const result = yield service.validateWebhookSignature(payload, timestamp, signature);
            expect(result).toBe(false);
        }));
        it('should return true when no signing secret is configured', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            Object.defineProperty(configService, 'slackSigningSecret', {
                get: jest.fn().mockReturnValue(''),
            });
            const result = yield service.validateWebhookSignature('payload', '123', 'sig');
            expect(result).toBe(true);
            expect(mockLogger.warn).toHaveBeenCalledWith('Slack signing secret not configured, skipping signature validation');
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL25vdGlmaWNhdGlvbnMvc2xhY2suc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFzRDtBQUN0RCx5Q0FBNEM7QUFDNUMscURBQW9EO0FBQ3BELG1EQUErQztBQUUvQywrQkFBMEI7QUFHMUIsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsSUFBSSxPQUFxQixDQUFDO0lBQzFCLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLGFBQTRCLENBQUM7SUFDakMsSUFBSSxNQUFrQixDQUFDO0lBRXZCLE1BQU0sZUFBZSxHQUFHO1FBQ3RCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2hCLENBQUM7SUFFRixNQUFNLGlCQUFpQixHQUFHO1FBQ3hCLElBQUksWUFBWSxLQUFLLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLGVBQWUsS0FBSyxPQUFPLCtDQUErQyxDQUFDLENBQUMsQ0FBQztRQUNqRixJQUFJLG1CQUFtQixLQUFLLE9BQU8sU0FBUyxDQUFDLENBQUMsQ0FBQztRQUMvQyxJQUFJLGtCQUFrQixLQUFLLE9BQU8sYUFBYSxDQUFDLENBQUMsQ0FBQztLQUNuRCxDQUFDO0lBRUYsTUFBTSxVQUFVLEdBQUc7UUFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNoQixDQUFDO0lBRUYsVUFBVSxDQUFDLEdBQVMsRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULDRCQUFZO2dCQUNaO29CQUNFLE9BQU8sRUFBRSxtQkFBVztvQkFDcEIsUUFB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b0JBQW9CLENBQzFDLG9FQUFvRSxDQUNyRSxDQUFDO1FBQ0osQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL25vdGlmaWNhdGlvbnMvc2xhY2suc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2F4aW9zJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAdmlzYXBpL2NvcmUtY29uZmlnJztcbmltcG9ydCB7IFNsYWNrU2VydmljZSB9IGZyb20gJy4vc2xhY2suc2VydmljZSc7XG5pbXBvcnQgeyBHcmFmYW5hV2ViaG9va1BheWxvYWQgfSBmcm9tICdAdmlzYXBpL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUGlub0xvZ2dlciB9IGZyb20gJ25lc3Rqcy1waW5vJztcblxuZGVzY3JpYmUoJ1NsYWNrU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFNsYWNrU2VydmljZTtcbiAgbGV0IGh0dHBTZXJ2aWNlOiBIdHRwU2VydmljZTtcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2U7XG4gIGxldCBsb2dnZXI6IFBpbm9Mb2dnZXI7XG5cbiAgY29uc3QgbW9ja0h0dHBTZXJ2aWNlID0ge1xuICAgIHBvc3Q6IGplc3QuZm4oKSxcbiAgfTtcblxuICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICBnZXQgc2xhY2tFbmFibGVkKCkgeyByZXR1cm4gdHJ1ZTsgfSxcbiAgICBnZXQgc2xhY2tXZWJob29rVXJsKCkgeyByZXR1cm4gJ2h0dHBzOi8vaG9va3Muc2xhY2suY29tL3NlcnZpY2VzL3Rlc3Qvd2ViaG9vayc7IH0sXG4gICAgZ2V0IHNsYWNrRGVmYXVsdENoYW5uZWwoKSB7IHJldHVybiAnI2FsZXJ0cyc7IH0sXG4gICAgZ2V0IHNsYWNrU2lnbmluZ1NlY3JldCgpIHsgcmV0dXJuICd0ZXN0LXNlY3JldCc7IH0sXG4gIH07XG5cbiAgY29uc3QgbW9ja0xvZ2dlciA9IHtcbiAgICBkZWJ1ZzogamVzdC5mbigpLFxuICAgIGluZm86IGplc3QuZm4oKSxcbiAgICBlcnJvcjogamVzdC5mbigpLFxuICAgIHdhcm46IGplc3QuZm4oKSxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFNsYWNrU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEh0dHBTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSHR0cFNlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQ29uZmlnU2VydmljZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IGBQaW5vTG9nZ2VyOiR7U2xhY2tTZXJ2aWNlLm5hbWV9YCxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0xvZ2dlcixcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8U2xhY2tTZXJ2aWNlPihTbGFja1NlcnZpY2UpO1xuICAgIGh0dHBTZXJ2aWNlID0gbW9kdWxlLmdldDxIdHRwU2VydmljZT4oSHR0cFNlcnZpY2UpO1xuICAgIGNvbmZpZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PENvbmZpZ1NlcnZpY2U+KENvbmZpZ1NlcnZpY2UpO1xuICAgIGxvZ2dlciA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dlcj4oYFBpbm9Mb2dnZXI6JHtTbGFja1NlcnZpY2UubmFtZX1gKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2VuZEdyYWZhbmFBbGVydCcsICgpID0+IHtcbiAgICBjb25zdCBtb2NrUGF5bG9hZDogR3JhZmFuYVdlYmhvb2tQYXlsb2FkID0ge1xuICAgICAgZGFzaGJvYXJkSWQ6IDEsXG4gICAgICBldmFsTWF0Y2hlczogW1xuICAgICAgICB7XG4gICAgICAgICAgdmFsdWU6IDc1LjUsXG4gICAgICAgICAgbWV0cmljOiAnY3B1X3VzYWdlJyxcbiAgICAgICAgICB0YWdzOiB7IGhvc3Q6ICdzZXJ2ZXItMScgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBtZXNzYWdlOiAnQ1BVIHVzYWdlIGlzIGFib3ZlIHRocmVzaG9sZCcsXG4gICAgICBvcmdJZDogMSxcbiAgICAgIHBhbmVsSWQ6IDIsXG4gICAgICBydWxlSWQ6IDMsXG4gICAgICBydWxlTmFtZTogJ0hpZ2ggQ1BVIFVzYWdlJyxcbiAgICAgIHJ1bGVVcmw6ICdodHRwczovL2dyYWZhbmEuZXhhbXBsZS5jb20vZC9kYXNoYm9hcmQvcGFuZWwnLFxuICAgICAgc3RhdGU6ICdhbGVydGluZycsXG4gICAgICB0YWdzOiB7IHNldmVyaXR5OiAnaGlnaCcgfSxcbiAgICAgIHRpdGxlOiAnSGlnaCBDUFUgVXNhZ2UgQWxlcnQnLFxuICAgIH07XG5cbiAgICBpdCgnc2hvdWxkIHNlbmQgR3JhZmFuYSBhbGVydCBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrSHR0cFNlcnZpY2UucG9zdC5tb2NrUmV0dXJuVmFsdWUob2YoeyBkYXRhOiB7IG9rOiB0cnVlIH0gfSkpO1xuXG4gICAgICBhd2FpdCBzZXJ2aWNlLnNlbmRHcmFmYW5hQWxlcnQobW9ja1BheWxvYWQpO1xuXG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvdGVzdC93ZWJob29rJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGNoYW5uZWw6ICcjYWxlcnRzJyxcbiAgICAgICAgICB1c2VybmFtZTogJ1Zpc0FQSSBNb25pdG9yaW5nJyxcbiAgICAgICAgICBpY29uX2Vtb2ppOiAnOmNoYXJ0X3dpdGhfdXB3YXJkc190cmVuZDonLFxuICAgICAgICAgIHRleHQ6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBTEVSVElORycpLFxuICAgICAgICAgIGF0dGFjaG1lbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29sb3I6ICdkYW5nZXInLFxuICAgICAgICAgICAgICB0aXRsZTogJ0hpZ2ggQ1BVIFVzYWdlJyxcbiAgICAgICAgICAgICAgdGl0bGVfbGluazogJ2h0dHBzOi8vZ3JhZmFuYS5leGFtcGxlLmNvbS9kL2Rhc2hib2FyZC9wYW5lbCcsXG4gICAgICAgICAgICAgIHRleHQ6ICdDUFUgdXNhZ2UgaXMgYWJvdmUgdGhyZXNob2xkJyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIF0pLFxuICAgICAgICB9KSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU2xhY2sgYWxlcnQgc2VudCBzdWNjZXNzZnVsbHknLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgcnVsZU5hbWU6ICdIaWdoIENQVSBVc2FnZScsXG4gICAgICAgICAgc3RhdGU6ICdhbGVydGluZycsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBza2lwIGFsZXJ0IHdoZW4gU2xhY2sgaXMgZGlzYWJsZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY29uZmlnU2VydmljZSwgJ3NsYWNrRW5hYmxlZCcsIHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKGZhbHNlKSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBzZXJ2aWNlLnNlbmRHcmFmYW5hQWxlcnQobW9ja1BheWxvYWQpO1xuXG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLnBvc3QpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5kZWJ1ZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdTbGFjayBpbnRlZ3JhdGlvbiBkaXNhYmxlZCwgc2tpcHBpbmcgYWxlcnQnXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWlzc2luZyB3ZWJob29rIFVSTCcsIGFzeW5jICgpID0+IHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb25maWdTZXJ2aWNlLCAnc2xhY2tXZWJob29rVXJsJywge1xuICAgICAgICBnZXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJycpLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEdyYWZhbmFBbGVydChtb2NrUGF5bG9hZCk7XG5cbiAgICAgIGV4cGVjdChtb2NrSHR0cFNlcnZpY2UucG9zdCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIGV4cGVjdChtb2NrTG9nZ2VyLmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1NsYWNrIHdlYmhvb2sgVVJMIG5vdCBjb25maWd1cmVkJ1xuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEhUVFAgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ05ldHdvcmsgZXJyb3InKTtcbiAgICAgIG1vY2tIdHRwU2VydmljZS5wb3N0Lm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLnNlbmRHcmFmYW5hQWxlcnQobW9ja1BheWxvYWQpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgICdOZXR3b3JrIGVycm9yJ1xuICAgICAgKTtcblxuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnRmFpbGVkIHRvIHNlbmQgU2xhY2sgYWxlcnQnLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZXJyb3I6ICdOZXR3b3JrIGVycm9yJyxcbiAgICAgICAgICBydWxlTmFtZTogJ0hpZ2ggQ1BVIFVzYWdlJyxcbiAgICAgICAgICBzdGF0ZTogJ2FsZXJ0aW5nJyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZvcm1hdCByZXNvbHZlZCBhbGVydCBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNvbHZlZFBheWxvYWQ6IEdyYWZhbmFXZWJob29rUGF5bG9hZCA9IHtcbiAgICAgICAgLi4ubW9ja1BheWxvYWQsXG4gICAgICAgIHN0YXRlOiAnb2snLFxuICAgICAgICBtZXNzYWdlOiAnQ1BVIHVzYWdlIGlzIGJhY2sgdG8gbm9ybWFsJyxcbiAgICAgIH07XG5cbiAgICAgIG1vY2tIdHRwU2VydmljZS5wb3N0Lm1vY2tSZXR1cm5WYWx1ZShvZih7IGRhdGE6IHsgb2s6IHRydWUgfSB9KSk7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEdyYWZhbmFBbGVydChyZXNvbHZlZFBheWxvYWQpO1xuXG4gICAgICBleHBlY3QobW9ja0h0dHBTZXJ2aWNlLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0ZXh0OiBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnT0snKSxcbiAgICAgICAgICBhdHRhY2htZW50czogZXhwZWN0LmFycmF5Q29udGFpbmluZyhbXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgIGNvbG9yOiAnZ29vZCcsXG4gICAgICAgICAgICAgIHByZXRleHQ6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdPSyBBbGVydCcpLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSksXG4gICAgICAgIH0pLFxuICAgICAgICBleHBlY3QuYW55KE9iamVjdClcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzZW5kQ3VzdG9tQWxlcnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZW5kIGN1c3RvbSBhbGVydCBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrSHR0cFNlcnZpY2UucG9zdC5tb2NrUmV0dXJuVmFsdWUob2YoeyBkYXRhOiB7IG9rOiB0cnVlIH0gfSkpO1xuXG4gICAgICBhd2FpdCBzZXJ2aWNlLnNlbmRDdXN0b21BbGVydCgnVGVzdCBtZXNzYWdlJywgJ3dhcm5pbmcnLCAnI3Rlc3QnKTtcblxuICAgICAgZXhwZWN0KG1vY2tIdHRwU2VydmljZS5wb3N0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2h0dHBzOi8vaG9va3Muc2xhY2suY29tL3NlcnZpY2VzL3Rlc3Qvd2ViaG9vaycsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBjaGFubmVsOiAnI3Rlc3QnLFxuICAgICAgICAgIHVzZXJuYW1lOiAnVmlzQVBJIFN5c3RlbScsXG4gICAgICAgICAgaWNvbl9lbW9qaTogJzpyb2JvdF9mYWNlOicsXG4gICAgICAgICAgdGV4dDogJzp3YXJuaW5nOiBUZXN0IG1lc3NhZ2UnLFxuICAgICAgICAgIGF0dGFjaG1lbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29sb3I6ICd3YXJuaW5nJyxcbiAgICAgICAgICAgICAgdGV4dDogJ1Rlc3QgbWVzc2FnZScsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICBdKSxcbiAgICAgICAgfSksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGltZW91dDogMTAwMDAsXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ0N1c3RvbSBTbGFjayBhbGVydCBzZW50IHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBzZXZlcml0eTogJ3dhcm5pbmcnLFxuICAgICAgICAgIGNoYW5uZWw6ICcjdGVzdCcsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1c2UgZGVmYXVsdCBjaGFubmVsIHdoZW4gbm9uZSBzcGVjaWZpZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrSHR0cFNlcnZpY2UucG9zdC5tb2NrUmV0dXJuVmFsdWUob2YoeyBkYXRhOiB7IG9rOiB0cnVlIH0gfSkpO1xuXG4gICAgICBhd2FpdCBzZXJ2aWNlLnNlbmRDdXN0b21BbGVydCgnVGVzdCBtZXNzYWdlJyk7XG5cbiAgICAgIGV4cGVjdChtb2NrSHR0cFNlcnZpY2UucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGNoYW5uZWw6ICcjYWxlcnRzJyxcbiAgICAgICAgfSksXG4gICAgICAgIGV4cGVjdC5hbnkoT2JqZWN0KVxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3ZhbGlkYXRlV2ViaG9va1NpZ25hdHVyZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIGZvciB2YWxpZCBzaWduYXR1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gJ3tcInRlc3RcIjogXCJkYXRhXCJ9JztcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9ICcxMjM0NTY3ODkwJztcbiAgICAgIGNvbnN0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuICAgICAgY29uc3Qgc2lnbmF0dXJlID0gJ3YwPScgKyBjcnlwdG9cbiAgICAgICAgLmNyZWF0ZUhtYWMoJ3NoYTI1NicsICd0ZXN0LXNlY3JldCcpXG4gICAgICAgIC51cGRhdGUoYHYwOiR7dGltZXN0YW1wfToke3BheWxvYWR9YClcbiAgICAgICAgLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudmFsaWRhdGVXZWJob29rU2lnbmF0dXJlKHBheWxvYWQsIHRpbWVzdGFtcCwgc2lnbmF0dXJlKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBpbnZhbGlkIHNpZ25hdHVyZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSAne1widGVzdFwiOiBcImRhdGFcIn0nO1xuICAgICAgY29uc3QgdGltZXN0YW1wID0gJzEyMzQ1Njc4OTAnO1xuICAgICAgY29uc3Qgc2lnbmF0dXJlID0gJ3YwPWludmFsaWRfc2lnbmF0dXJlJztcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS52YWxpZGF0ZVdlYmhvb2tTaWduYXR1cmUocGF5bG9hZCwgdGltZXN0YW1wLCBzaWduYXR1cmUpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgd2hlbiBubyBzaWduaW5nIHNlY3JldCBpcyBjb25maWd1cmVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbmZpZ1NlcnZpY2UsICdzbGFja1NpZ25pbmdTZWNyZXQnLCB7XG4gICAgICAgIGdldDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSgnJyksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS52YWxpZGF0ZVdlYmhvb2tTaWduYXR1cmUoJ3BheWxvYWQnLCAnMTIzJywgJ3NpZycpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdTbGFjayBzaWduaW5nIHNlY3JldCBub3QgY29uZmlndXJlZCwgc2tpcHBpbmcgc2lnbmF0dXJlIHZhbGlkYXRpb24nXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==