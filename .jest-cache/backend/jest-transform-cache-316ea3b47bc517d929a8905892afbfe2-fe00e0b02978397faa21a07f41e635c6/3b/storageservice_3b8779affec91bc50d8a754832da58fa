3ee8802a7a81ce7ded7745c929ccb410
"use strict";
var StorageService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageService = void 0;
const tslib_1 = require("tslib");
const common_1 = require("@nestjs/common");
const supabase_service_1 = require("./supabase.service");
const nestjs_pino_1 = require("nestjs-pino");
let StorageService = StorageService_1 = class StorageService {
    constructor(supabase, logger) {
        this.supabase = supabase;
        this.logger = logger;
        this.BUCKET_NAME = 'receipts';
        this.SIGNED_URL_EXPIRY = 24 * 60 * 60; // 24 hours in seconds
        this.logger.setContext(StorageService_1.name);
    }
    /**
     * Upload a file to Supabase storage
     */
    uploadFile(path_1, buffer_1) {
        return tslib_1.__awaiter(this, arguments, void 0, function* (path, buffer, options = {}) {
            const { contentType = 'application/pdf', cacheControl = '3600', upsert = true } = options;
            try {
                // Upload file to storage
                const { data, error } = yield this.supabase.serviceClient.storage
                    .from(this.BUCKET_NAME)
                    .upload(path, buffer, {
                    contentType,
                    cacheControl,
                    upsert,
                });
                if (error) {
                    this.logger.error({ error, path }, 'Failed to upload file to storage');
                    throw error;
                }
                // Get public URL
                const publicUrl = this.getPublicUrl(path);
                // Generate signed URL for temporary access
                const signedUrl = yield this.createSignedUrl(path);
                this.logger.info({ path, publicUrl }, 'File uploaded successfully');
                return {
                    path: data.path,
                    publicUrl,
                    signedUrl,
                };
            }
            catch (error) {
                this.logger.error({ error, path }, 'Error uploading file');
                throw error;
            }
        });
    }
    /**
     * Delete a file from storage
     */
    deleteFile(path) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const { error } = yield this.supabase.serviceClient.storage
                    .from(this.BUCKET_NAME)
                    .remove([path]);
                if (error) {
                    this.logger.error({ error, path }, 'Failed to delete file from storage');
                    throw error;
                }
                this.logger.info({ path }, 'File deleted successfully');
            }
            catch (error) {
                this.logger.error({ error, path }, 'Error deleting file');
                throw error;
            }
        });
    }
    /**
     * Create a signed URL for temporary access
     */
    createSignedUrl(path_1) {
        return tslib_1.__awaiter(this, arguments, void 0, function* (path, expiresIn = this.SIGNED_URL_EXPIRY) {
            try {
                const { data, error } = yield this.supabase.serviceClient.storage
                    .from(this.BUCKET_NAME)
                    .createSignedUrl(path, expiresIn);
                if (error) {
                    this.logger.error({ error, path }, 'Failed to create signed URL');
                    throw error;
                }
                return data.signedUrl;
            }
            catch (error) {
                this.logger.error({ error, path }, 'Error creating signed URL');
                throw error;
            }
        });
    }
    /**
     * Get the public URL for a file
     */
    getPublicUrl(path) {
        const { data } = this.supabase.client.storage
            .from(this.BUCKET_NAME)
            .getPublicUrl(path);
        return data.publicUrl;
    }
    /**
     * Check if a file exists in storage
     */
    fileExists(path) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const { data, error } = yield this.supabase.serviceClient.storage
                    .from(this.BUCKET_NAME)
                    .list(path.substring(0, path.lastIndexOf('/')), {
                    search: path.substring(path.lastIndexOf('/') + 1),
                });
                if (error) {
                    this.logger.error({ error, path }, 'Failed to check if file exists');
                    return false;
                }
                return data.length > 0;
            }
            catch (error) {
                this.logger.error({ error, path }, 'Error checking file existence');
                return false;
            }
        });
    }
    /**
     * List files in a directory
     */
    listFiles(prefix_1) {
        return tslib_1.__awaiter(this, arguments, void 0, function* (prefix, limit = 100, offset = 0) {
            try {
                const { data, error } = yield this.supabase.serviceClient.storage
                    .from(this.BUCKET_NAME)
                    .list(prefix, {
                    limit,
                    offset,
                });
                if (error) {
                    this.logger.error({ error, prefix }, 'Failed to list files');
                    throw error;
                }
                return data.map(file => `${prefix}/${file.name}`);
            }
            catch (error) {
                this.logger.error({ error, prefix }, 'Error listing files');
                throw error;
            }
        });
    }
};
exports.StorageService = StorageService;
exports.StorageService = StorageService = StorageService_1 = tslib_1.__decorate([
    (0, common_1.Injectable)(),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof supabase_service_1.SupabaseService !== "undefined" && supabase_service_1.SupabaseService) === "function" ? _a : Object, typeof (_b = typeof nestjs_pino_1.PinoLogger !== "undefined" && nestjs_pino_1.PinoLogger) === "function" ? _b : Object])
], StorageService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9saWJzL2JhY2tlbmQvY29yZS1zdXBhYmFzZS9zcmMvbGliL3N0b3JhZ2Uuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMseURBQXFEO0FBQ3JELDZDQUF5QztBQWVsQyxJQUFNLGNBQWMsc0JBQXBCLE1BQU0sY0FBYztJQUl6QixZQUNtQixRQUF5QixFQUN6QixNQUFrQjtRQURsQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBTHBCLGdCQUFXLEdBQUcsVUFBVSxDQUFDO1FBQ3pCLHNCQUFpQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsc0JBQXNCO1FBTXZFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGdCQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVEOztPQUVHO0lBQ0csVUFBVTtxRUFDZCxJQUFZLEVBQ1osTUFBYyxFQUNkLFVBQWdDLEVBQUU7WUFFbEMsTUFBTSxFQUFFLFdBQVcsR0FBRyxpQkFBaUIsRUFBRSxZQUFZLEdBQUcsTUFBTSxFQUFFLE1BQU0sR0FBRyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUM7WUFFMUYsSUFBSSxDQUFDO2dCQUNILHlCQUF5QjtnQkFDekIsTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU87cUJBQzlELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO3FCQUN0QixNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRTtvQkFDcEIsV0FBVztvQkFDWCxZQUFZO29CQUNaLE1BQU07aUJBQ1AsQ0FBQyxDQUFDO2dCQUVMLElBQUksS0FBSyxFQUFFLENBQUM7b0JBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVB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RUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU87cUJBQzlELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO3FCQUN0QixJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNaLEtBQUs7b0JBQ0wsTUFBTTtpQkFDUCxDQUFDLENBQUM7Z0JBRUwsSUFBSSxLQUFLLEVBQUUsQ0FBQztvQkFDVixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO29CQUM3RCxNQUFNLEtBQUssQ0FBQztnQkFDZCxDQUFDO2dCQUVELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLHFCQUFxQixDQUFDLENBQUM7Z0JBQzVELE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztRQUNILENBQUM7S0FBQTtDQUNGLENBQUE7QUExSlksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7aUVBTWtCLGtDQUFlLG9CQUFmLGtDQUFlLG9EQUNqQix3QkFBVSxvQkFBVix3QkFBVTtHQU4xQixjQUFjLENBMEoxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdmFkaW0vUHJvamVjdHMvVmlzQVBJL2xpYnMvYmFja2VuZC9jb3JlLXN1cGFiYXNlL3NyYy9saWIvc3RvcmFnZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBTdXBhYmFzZVNlcnZpY2UgfSBmcm9tICcuL3N1cGFiYXNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGlub0xvZ2dlciB9IGZyb20gJ25lc3Rqcy1waW5vJztcblxuZXhwb3J0IGludGVyZmFjZSBTdG9yYWdlVXBsb2FkT3B0aW9ucyB7XG4gIGNvbnRlbnRUeXBlPzogc3RyaW5nO1xuICBjYWNoZUNvbnRyb2w/OiBzdHJpbmc7XG4gIHVwc2VydD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RvcmFnZUZpbGUge1xuICBwYXRoOiBzdHJpbmc7XG4gIHB1YmxpY1VybDogc3RyaW5nO1xuICBzaWduZWRVcmw/OiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdG9yYWdlU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgQlVDS0VUX05BTUUgPSAncmVjZWlwdHMnO1xuICBwcml2YXRlIHJlYWRvbmx5IFNJR05FRF9VUkxfRVhQSVJZID0gMjQgKiA2MCAqIDYwOyAvLyAyNCBob3VycyBpbiBzZWNvbmRzXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdXBhYmFzZTogU3VwYWJhc2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBQaW5vTG9nZ2VyXG4gICkge1xuICAgIHRoaXMubG9nZ2VyLnNldENvbnRleHQoU3RvcmFnZVNlcnZpY2UubmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogVXBsb2FkIGEgZmlsZSB0byBTdXBhYmFzZSBzdG9yYWdlXG4gICAqL1xuICBhc3luYyB1cGxvYWRGaWxlKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBidWZmZXI6IEJ1ZmZlcixcbiAgICBvcHRpb25zOiBTdG9yYWdlVXBsb2FkT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8U3RvcmFnZUZpbGU+IHtcbiAgICBjb25zdCB7IGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3BkZicsIGNhY2hlQ29udHJvbCA9ICczNjAwJywgdXBzZXJ0ID0gdHJ1ZSB9ID0gb3B0aW9ucztcblxuICAgIHRyeSB7XG4gICAgICAvLyBVcGxvYWQgZmlsZSB0byBzdG9yYWdlXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCB0aGlzLnN1cGFiYXNlLnNlcnZpY2VDbGllbnQuc3RvcmFnZVxuICAgICAgICAuZnJvbSh0aGlzLkJVQ0tFVF9OQU1FKVxuICAgICAgICAudXBsb2FkKHBhdGgsIGJ1ZmZlciwge1xuICAgICAgICAgIGNvbnRlbnRUeXBlLFxuICAgICAgICAgIGNhY2hlQ29udHJvbCxcbiAgICAgICAgICB1cHNlcnQsXG4gICAgICAgIH0pO1xuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoeyBlcnJvciwgcGF0aCB9LCAnRmFpbGVkIHRvIHVwbG9hZCBmaWxlIHRvIHN0b3JhZ2UnKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBwdWJsaWMgVVJMXG4gICAgICBjb25zdCBwdWJsaWNVcmwgPSB0aGlzLmdldFB1YmxpY1VybChwYXRoKTtcblxuICAgICAgLy8gR2VuZXJhdGUgc2lnbmVkIFVSTCBmb3IgdGVtcG9yYXJ5IGFjY2Vzc1xuICAgICAgY29uc3Qgc2lnbmVkVXJsID0gYXdhaXQgdGhpcy5jcmVhdGVTaWduZWRVcmwocGF0aCk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmluZm8oeyBwYXRoLCBwdWJsaWNVcmwgfSwgJ0ZpbGUgdXBsb2FkZWQgc3VjY2Vzc2Z1bGx5Jyk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBhdGg6IGRhdGEucGF0aCxcbiAgICAgICAgcHVibGljVXJsLFxuICAgICAgICBzaWduZWRVcmwsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdFcnJvciB1cGxvYWRpbmcgZmlsZScpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIGZpbGUgZnJvbSBzdG9yYWdlXG4gICAqL1xuICBhc3luYyBkZWxldGVGaWxlKHBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCB0aGlzLnN1cGFiYXNlLnNlcnZpY2VDbGllbnQuc3RvcmFnZVxuICAgICAgICAuZnJvbSh0aGlzLkJVQ0tFVF9OQU1FKVxuICAgICAgICAucmVtb3ZlKFtwYXRoXSk7XG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdGYWlsZWQgdG8gZGVsZXRlIGZpbGUgZnJvbSBzdG9yYWdlJyk7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKHsgcGF0aCB9LCAnRmlsZSBkZWxldGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdFcnJvciBkZWxldGluZyBmaWxlJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgc2lnbmVkIFVSTCBmb3IgdGVtcG9yYXJ5IGFjY2Vzc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlU2lnbmVkVXJsKHBhdGg6IHN0cmluZywgZXhwaXJlc0luID0gdGhpcy5TSUdORURfVVJMX0VYUElSWSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuc3VwYWJhc2Uuc2VydmljZUNsaWVudC5zdG9yYWdlXG4gICAgICAgIC5mcm9tKHRoaXMuQlVDS0VUX05BTUUpXG4gICAgICAgIC5jcmVhdGVTaWduZWRVcmwocGF0aCwgZXhwaXJlc0luKTtcblxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKHsgZXJyb3IsIHBhdGggfSwgJ0ZhaWxlZCB0byBjcmVhdGUgc2lnbmVkIFVSTCcpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRhdGEuc2lnbmVkVXJsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdFcnJvciBjcmVhdGluZyBzaWduZWQgVVJMJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBwdWJsaWMgVVJMIGZvciBhIGZpbGVcbiAgICovXG4gIGdldFB1YmxpY1VybChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gdGhpcy5zdXBhYmFzZS5jbGllbnQuc3RvcmFnZVxuICAgICAgLmZyb20odGhpcy5CVUNLRVRfTkFNRSlcbiAgICAgIC5nZXRQdWJsaWNVcmwocGF0aCk7XG5cbiAgICByZXR1cm4gZGF0YS5wdWJsaWNVcmw7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgYSBmaWxlIGV4aXN0cyBpbiBzdG9yYWdlXG4gICAqL1xuICBhc3luYyBmaWxlRXhpc3RzKHBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCB0aGlzLnN1cGFiYXNlLnNlcnZpY2VDbGllbnQuc3RvcmFnZVxuICAgICAgICAuZnJvbSh0aGlzLkJVQ0tFVF9OQU1FKVxuICAgICAgICAubGlzdChwYXRoLnN1YnN0cmluZygwLCBwYXRoLmxhc3RJbmRleE9mKCcvJykpLCB7XG4gICAgICAgICAgc2VhcmNoOiBwYXRoLnN1YnN0cmluZyhwYXRoLmxhc3RJbmRleE9mKCcvJykgKyAxKSxcbiAgICAgICAgfSk7XG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdGYWlsZWQgdG8gY2hlY2sgaWYgZmlsZSBleGlzdHMnKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF0YS5sZW5ndGggPiAwO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcih7IGVycm9yLCBwYXRoIH0sICdFcnJvciBjaGVja2luZyBmaWxlIGV4aXN0ZW5jZScpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0IGZpbGVzIGluIGEgZGlyZWN0b3J5XG4gICAqL1xuICBhc3luYyBsaXN0RmlsZXMocHJlZml4OiBzdHJpbmcsIGxpbWl0ID0gMTAwLCBvZmZzZXQgPSAwKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCB0aGlzLnN1cGFiYXNlLnNlcnZpY2VDbGllbnQuc3RvcmFnZVxuICAgICAgICAuZnJvbSh0aGlzLkJVQ0tFVF9OQU1FKVxuICAgICAgICAubGlzdChwcmVmaXgsIHtcbiAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICBvZmZzZXQsXG4gICAgICAgIH0pO1xuXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoeyBlcnJvciwgcHJlZml4IH0sICdGYWlsZWQgdG8gbGlzdCBmaWxlcycpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRhdGEubWFwKGZpbGUgPT4gYCR7cHJlZml4fS8ke2ZpbGUubmFtZX1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoeyBlcnJvciwgcHJlZml4IH0sICdFcnJvciBsaXN0aW5nIGZpbGVzJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=