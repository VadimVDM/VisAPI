98b8926d6b2c43ee5b6ea58d756b5f8b
"use strict";
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApiKeysController = void 0;
const tslib_1 = require("tslib");
const common_1 = require("@nestjs/common");
const auth_service_1 = require("../auth/auth.service");
const api_key_guard_1 = require("../auth/guards/api-key.guard");
const scopes_decorator_1 = require("../auth/decorators/scopes.decorator");
const create_api_key_dto_1 = require("./dto/create-api-key.dto");
const api_key_response_dto_1 = require("./dto/api-key-response.dto");
const swagger_1 = require("@nestjs/swagger");
let ApiKeysController = class ApiKeysController {
    constructor(authService) {
        this.authService = authService;
    }
    listApiKeys(req) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const keys = yield this.authService.listApiKeys();
            return keys.map(api_key_response_dto_1.ApiKeyResponseDto.fromRecord);
        });
    }
    createApiKey(dto, req) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { key, apiKey } = yield this.authService.createApiKey(dto.name, dto.scopes, req.apiKey.created_by || 'system');
            return api_key_response_dto_1.ApiKeyWithSecretResponseDto.fromRecordWithKey(apiKey, key);
        });
    }
    revokeApiKey(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield this.authService.revokeApiKey(id);
            return { message: 'API key revoked successfully' };
        });
    }
};
exports.ApiKeysController = ApiKeysController;
tslib_1.__decorate([
    (0, common_1.Get)(),
    (0, scopes_decorator_1.Scopes)('keys:read'),
    (0, swagger_1.ApiOperation)({ summary: 'List all API keys' }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Returns array of API keys',
        type: [api_key_response_dto_1.ApiKeyResponseDto],
    }),
    tslib_1.__param(0, (0, common_1.Request)()),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", typeof (_b = typeof Promise !== "undefined" && Promise) === "function" ? _b : Object)
], ApiKeysController.prototype, "listApiKeys", null);
tslib_1.__decorate([
    (0, common_1.Post)(),
    (0, scopes_decorator_1.Scopes)('keys:create'),
    (0, swagger_1.ApiOperation)({ summary: 'Create a new API key' }),
    (0, swagger_1.ApiResponse)({
        status: 201,
        description: 'Returns the created API key with secret',
        type: api_key_response_dto_1.ApiKeyWithSecretResponseDto,
    }),
    tslib_1.__param(0, (0, common_1.Body)()),
    tslib_1.__param(1, (0, common_1.Request)()),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_c = typeof create_api_key_dto_1.CreateApiKeyDto !== "undefined" && create_api_key_dto_1.CreateApiKeyDto) === "function" ? _c : Object, Object]),
    tslib_1.__metadata("design:returntype", typeof (_d = typeof Promise !== "undefined" && Promise) === "function" ? _d : Object)
], ApiKeysController.prototype, "createApiKey", null);
tslib_1.__decorate([
    (0, common_1.Delete)(':id'),
    (0, scopes_decorator_1.Scopes)('keys:delete'),
    (0, swagger_1.ApiOperation)({ summary: 'Revoke an API key' }),
    (0, swagger_1.ApiResponse)({ status: 204, description: 'Key successfully revoked' }),
    tslib_1.__param(0, (0, common_1.Param)('id')),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [String]),
    tslib_1.__metadata("design:returntype", Promise)
], ApiKeysController.prototype, "revokeApiKey", null);
exports.ApiKeysController = ApiKeysController = tslib_1.__decorate([
    (0, swagger_1.ApiTags)('API Keys'),
    (0, common_1.Controller)('api/v1/api-keys'),
    (0, common_1.UseGuards)(api_key_guard_1.ApiKeyGuard),
    (0, swagger_1.ApiSecurity)('api-key'),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof auth_service_1.AuthService !== "undefined" && auth_service_1.AuthService) === "function" ? _a : Object])
], ApiKeysController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL2FwaS1rZXlzL2FwaS1rZXlzLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FTd0I7QUFDeEIsdURBQW1EO0FBQ25ELGdFQUEyRDtBQUMzRCwwRUFBNkQ7QUFDN0QsaUVBQTJEO0FBQzNELHFFQUdvQztBQUNwQyw2Q0FLeUI7QUFNbEIsSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBaUI7SUFDNUIsWUFBNkIsV0FBd0I7UUFBeEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7SUFBRyxDQUFDO0lBVW5ELFdBQVcsQ0FBWSxHQUFROztZQUNuQyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLHdDQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2hELENBQUM7S0FBQTtJQVVLLFlBQVksQ0FDUixHQUFvQixFQUNqQixHQUFROztZQUVuQixNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQ3pELEdBQUcsQ0FBQyxJQUFJLEVBQ1IsR0FBRyxDQUFDLE1BQU0sRUFDVixHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQ2xDLENBQUM7WUFFRixPQUFPLGtEQUEyQixDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNwRSxDQUFDO0tBQUE7SUFNSyxZQUFZLENBQWMsRUFBVTs7WUFDeEMsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN4QyxPQUFPLEVBQUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLENBQUM7UUFDckQsQ0FBQztLQUFBO0NBQ0YsQ0FBQTtBQTdDWSw4Q0FBaUI7QUFXdEI7SUFSTCxJQUFBLFlBQUcsR0FBRTtJQUNMLElBQUEseUJBQU0sRUFBQyxXQUFXLENBQUM7SUFDbkIsSUFBQSxzQkFBWSxFQUFDLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUM7SUFDOUMsSUFBQSxxQkFBVyxFQUFDO1FBQ1gsTUFBTSxFQUFFLEdBQUc7UUFDWCxXQUFXLEVBQUUsMkJBQTJCO1FBQ3hDLElBQUksRUFBRSxDQUFDLHdDQUFpQixDQUFDO0tBQzFCLENBQUM7SUFDaUIsbUJBQUEsSUFBQSxnQkFBTyxHQUFFLENBQUE7OztnRUFBWSxPQUFPLG9CQUFQLE9BQU87b0RBRzlDO0FBVUs7SUFSTCxJQUFBLGFBQUksR0FBRTtJQUNOLElBQUEseUJBQU0sRUFBQyxhQUFhLENBQUM7SUFDckIsSUFBQSxzQkFBWSxFQUFDLEVBQUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLENBQUM7SUFDakQsSUFBQSxxQkFBVyxFQUFDO1FBQ1gsTUFBTSxFQUFFLEdBQUc7UUFDWCxXQUFXLEVBQUUseUNBQXlDO1FBQ3RELElBQUksRUFBRSxrREFBMkI7S0FDbEMsQ0FBQztJQUVDLG1CQUFBLElBQUEsYUFBSSxHQUFFLENBQUE7SUFDTixtQkFBQSxJQUFBLGdCQUFPLEdBQUUsQ0FBQTs7aUVBREcsb0NBQWUsb0JBQWYsb0NBQWU7Z0VBRTNCLE9BQU8sb0JBQVAsT0FBTztxREFRVDtBQU1LO0lBSkwsSUFBQSxlQUFNLEVBQUMsS0FBSyxDQUFDO0lBQ2IsSUFBQSx5QkFBTSxFQUFDLGFBQWEsQ0FBQztJQUNyQixJQUFBLHNCQUFZLEVBQUMsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQztJQUM5QyxJQUFBLHFCQUFXLEVBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSwwQkFBMEIsRUFBRSxDQUFDO0lBQ2xELG1CQUFBLElBQUEsY0FBSyxFQUFDLElBQUksQ0FBQyxDQUFBOzs7O3FEQUc5Qjs0QkE1Q1UsaUJBQWlCO0lBSjdCLElBQUEsaUJBQU8sRUFBQyxVQUFVLENBQUM7SUFDbkIsSUFBQSxtQkFBVSxFQUFDLGlCQUFpQixDQUFDO0lBQzdCLElBQUEsa0JBQVMsRUFBQywyQkFBVyxDQUFDO0lBQ3RCLElBQUEscUJBQVcsRUFBQyxTQUFTLENBQUM7aUVBRXFCLDBCQUFXLG9CQUFYLDBCQUFXO0dBRDFDLGlCQUFpQixDQTZDN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL2FwaS1rZXlzL2FwaS1rZXlzLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgR2V0LFxuICBQb3N0LFxuICBEZWxldGUsXG4gIEJvZHksXG4gIFBhcmFtLFxuICBVc2VHdWFyZHMsXG4gIFJlcXVlc3QsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vYXV0aC9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBpS2V5R3VhcmQgfSBmcm9tICcuLi9hdXRoL2d1YXJkcy9hcGkta2V5Lmd1YXJkJztcbmltcG9ydCB7IFNjb3BlcyB9IGZyb20gJy4uL2F1dGgvZGVjb3JhdG9ycy9zY29wZXMuZGVjb3JhdG9yJztcbmltcG9ydCB7IENyZWF0ZUFwaUtleUR0byB9IGZyb20gJy4vZHRvL2NyZWF0ZS1hcGkta2V5LmR0byc7XG5pbXBvcnQge1xuICBBcGlLZXlSZXNwb25zZUR0byxcbiAgQXBpS2V5V2l0aFNlY3JldFJlc3BvbnNlRHRvLFxufSBmcm9tICcuL2R0by9hcGkta2V5LXJlc3BvbnNlLmR0byc7XG5pbXBvcnQge1xuICBBcGlUYWdzLFxuICBBcGlPcGVyYXRpb24sXG4gIEFwaVJlc3BvbnNlLFxuICBBcGlTZWN1cml0eSxcbn0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcblxuQEFwaVRhZ3MoJ0FQSSBLZXlzJylcbkBDb250cm9sbGVyKCdhcGkvdjEvYXBpLWtleXMnKVxuQFVzZUd1YXJkcyhBcGlLZXlHdWFyZClcbkBBcGlTZWN1cml0eSgnYXBpLWtleScpXG5leHBvcnQgY2xhc3MgQXBpS2V5c0NvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSkge31cblxuICBAR2V0KClcbiAgQFNjb3Blcygna2V5czpyZWFkJylcbiAgQEFwaU9wZXJhdGlvbih7IHN1bW1hcnk6ICdMaXN0IGFsbCBBUEkga2V5cycgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBkZXNjcmlwdGlvbjogJ1JldHVybnMgYXJyYXkgb2YgQVBJIGtleXMnLFxuICAgIHR5cGU6IFtBcGlLZXlSZXNwb25zZUR0b10sXG4gIH0pXG4gIGFzeW5jIGxpc3RBcGlLZXlzKEBSZXF1ZXN0KCkgcmVxOiBhbnkpOiBQcm9taXNlPEFwaUtleVJlc3BvbnNlRHRvW10+IHtcbiAgICBjb25zdCBrZXlzID0gYXdhaXQgdGhpcy5hdXRoU2VydmljZS5saXN0QXBpS2V5cygpO1xuICAgIHJldHVybiBrZXlzLm1hcChBcGlLZXlSZXNwb25zZUR0by5mcm9tUmVjb3JkKTtcbiAgfVxuXG4gIEBQb3N0KClcbiAgQFNjb3Blcygna2V5czpjcmVhdGUnKVxuICBAQXBpT3BlcmF0aW9uKHsgc3VtbWFyeTogJ0NyZWF0ZSBhIG5ldyBBUEkga2V5JyB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAxLFxuICAgIGRlc2NyaXB0aW9uOiAnUmV0dXJucyB0aGUgY3JlYXRlZCBBUEkga2V5IHdpdGggc2VjcmV0JyxcbiAgICB0eXBlOiBBcGlLZXlXaXRoU2VjcmV0UmVzcG9uc2VEdG8sXG4gIH0pXG4gIGFzeW5jIGNyZWF0ZUFwaUtleShcbiAgICBAQm9keSgpIGR0bzogQ3JlYXRlQXBpS2V5RHRvLFxuICAgIEBSZXF1ZXN0KCkgcmVxOiBhbnlcbiAgKTogUHJvbWlzZTxBcGlLZXlXaXRoU2VjcmV0UmVzcG9uc2VEdG8+IHtcbiAgICBjb25zdCB7IGtleSwgYXBpS2V5IH0gPSBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZUFwaUtleShcbiAgICAgIGR0by5uYW1lLFxuICAgICAgZHRvLnNjb3BlcyxcbiAgICAgIHJlcS5hcGlLZXkuY3JlYXRlZF9ieSB8fCAnc3lzdGVtJ1xuICAgICk7XG5cbiAgICByZXR1cm4gQXBpS2V5V2l0aFNlY3JldFJlc3BvbnNlRHRvLmZyb21SZWNvcmRXaXRoS2V5KGFwaUtleSwga2V5KTtcbiAgfVxuXG4gIEBEZWxldGUoJzppZCcpXG4gIEBTY29wZXMoJ2tleXM6ZGVsZXRlJylcbiAgQEFwaU9wZXJhdGlvbih7IHN1bW1hcnk6ICdSZXZva2UgYW4gQVBJIGtleScgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiAyMDQsIGRlc2NyaXB0aW9uOiAnS2V5IHN1Y2Nlc3NmdWxseSByZXZva2VkJyB9KVxuICBhc3luYyByZXZva2VBcGlLZXkoQFBhcmFtKCdpZCcpIGlkOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLnJldm9rZUFwaUtleShpZCk7XG4gICAgcmV0dXJuIHsgbWVzc2FnZTogJ0FQSSBrZXkgcmV2b2tlZCBzdWNjZXNzZnVsbHknIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==