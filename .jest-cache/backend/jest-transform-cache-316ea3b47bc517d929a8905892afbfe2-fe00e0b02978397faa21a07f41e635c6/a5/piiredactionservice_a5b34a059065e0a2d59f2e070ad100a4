b1660603ca689863e4083dc9cea62e8b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PiiRedactionService = void 0;
const tslib_1 = require("tslib");
const common_1 = require("@nestjs/common");
let PiiRedactionService = class PiiRedactionService {
    constructor() {
        // PII detection patterns - ordered by specificity to avoid conflicts
        this.patterns = {
            // Process credit cards first (more specific)
            creditCard: {
                regex: /\b(?:\d{4}[-.\s]?){3}\d{4}\b/g,
                replacement: '[CARD_REDACTED]',
                name: 'credit_card'
            },
            // Process phone numbers after credit cards (less specific)
            phone: {
                regex: /(\s|^)(\+?1?[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,
                replacement: '$1[PHONE_REDACTED]',
                name: 'phone_number'
            },
            email: {
                regex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
                replacement: '[EMAIL_REDACTED]',
                name: 'email'
            },
            ssn: {
                regex: /\b\d{3}-?\d{2}-?\d{4}\b/g,
                replacement: '[SSN_REDACTED]',
                name: 'ssn'
            },
            ipAddress: {
                regex: /\b(?:\d{1,3}\.){3}\d{1,3}\b/g,
                replacement: '[IP_REDACTED]',
                name: 'ip_address'
            },
            // Generic patterns for common PII keywords
            address: {
                regex: /\b\d+\s+[A-Za-z\s]+(?:street|st|avenue|ave|road|rd|drive|dr|lane|ln|court|ct|place|pl)\b/gi,
                replacement: '[ADDRESS_REDACTED]',
                name: 'address'
            },
            // API keys and tokens
            apiKey: {
                regex: /\b[A-Za-z0-9]{32,}\b/g,
                replacement: '[API_KEY_REDACTED]',
                name: 'api_key'
            },
            // UUIDs (potential sensitive identifiers)
            uuid: {
                regex: /\b[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\b/gi,
                replacement: '[UUID_REDACTED]',
                name: 'uuid'
            }
        };
    }
    /**
     * Redact PII from text content
     */
    redactPii(text) {
        if (!text || typeof text !== 'string') {
            return {
                text: '',
                piiFound: false,
                redactedFields: []
            };
        }
        let redactedText = text;
        const redactedFields = [];
        // Apply each pattern
        for (const [key, pattern] of Object.entries(this.patterns)) {
            const matches = redactedText.match(pattern.regex);
            if (matches && matches.length > 0) {
                redactedText = redactedText.replace(pattern.regex, pattern.replacement);
                redactedFields.push(pattern.name);
            }
        }
        return {
            text: redactedText,
            piiFound: redactedFields.length > 0,
            redactedFields
        };
    }
    /**
     * Redact PII from an object (recursively)
     */
    redactPiiFromObject(obj) {
        if (!obj || typeof obj !== 'object') {
            if (typeof obj === 'string') {
                const result = this.redactPii(obj);
                return { obj: result.text, piiFound: result.piiFound, redactedFields: result.redactedFields };
            }
            return { obj, piiFound: false, redactedFields: [] };
        }
        const redactedObj = Array.isArray(obj) ? [] : {};
        let globalPiiFound = false;
        const globalRedactedFields = [];
        for (const [key, value] of Object.entries(obj)) {
            if (typeof value === 'string') {
                const result = this.redactPii(value);
                redactedObj[key] = result.text;
                if (result.piiFound) {
                    globalPiiFound = true;
                    globalRedactedFields.push(...result.redactedFields);
                }
            }
            else if (typeof value === 'object' && value !== null) {
                const result = this.redactPiiFromObject(value);
                redactedObj[key] = result.obj;
                if (result.piiFound) {
                    globalPiiFound = true;
                    globalRedactedFields.push(...result.redactedFields);
                }
            }
            else {
                redactedObj[key] = value;
            }
        }
        return {
            obj: redactedObj,
            piiFound: globalPiiFound,
            redactedFields: [...new Set(globalRedactedFields)]
        };
    }
    /**
     * Check if text contains PII without redacting
     */
    containsPii(text) {
        if (!text || typeof text !== 'string') {
            return false;
        }
        return Object.values(this.patterns).some(pattern => pattern.regex.test(text));
    }
    /**
     * Get PII detection statistics
     */
    getPiiStats(text) {
        const stats = {};
        for (const [key, pattern] of Object.entries(this.patterns)) {
            const matches = text.match(pattern.regex);
            stats[pattern.name] = matches ? matches.length : 0;
        }
        return stats;
    }
    /**
     * Add custom PII pattern
     */
    addPattern(name, regex, replacement) {
        this.patterns[name] = {
            regex,
            replacement,
            name
        };
    }
    /**
     * Remove PII pattern
     */
    removePattern(name) {
        delete this.patterns[name];
    }
    /**
     * Get all configured patterns
     */
    getPatterns() {
        return Object.assign({}, this.patterns);
    }
};
exports.PiiRedactionService = PiiRedactionService;
exports.PiiRedactionService = PiiRedactionService = tslib_1.__decorate([
    (0, common_1.Injectable)()
], PiiRedactionService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL2xvZ3Mvc2VydmljZXMvcGlpLXJlZGFjdGlvbi5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7QUFBQSwyQ0FBNEM7QUFTckMsSUFBTSxtQkFBbUIsR0FBekIsTUFBTSxtQkFBbUI7SUFBekI7UUFDTCxxRUFBcUU7UUFDcEQsYUFBUSxHQUFHO1lBQzFCLDZDQUE2QztZQUM3QyxVQUFVLEVBQUU7Z0JBQ1YsS0FBSyxFQUFFLCtCQUErQjtnQkFDdEMsV0FBVyxFQUFFLGlCQUFpQjtnQkFDOUIsSUFBSSxFQUFFLGFBQWE7YUFDcEI7WUFDRCwyREFBMkQ7WUFDM0QsS0FBSyxFQUFFO2dCQUNMLEtBQUssRUFBRSw2REFBNkQ7Z0JBQ3BFLFdBQVcsRUFBRSxvQkFBb0I7Z0JBQ2pDLElBQUksRUFBRSxjQUFjO2FBQ3JCO1lBQ0QsS0FBSyxFQUFFO2dCQUNMLEtBQUssRUFBRSxpREFBaUQ7Z0JBQ3hELFdBQVcsRUFBRSxrQkFBa0I7Z0JBQy9CLElBQUksRUFBRSxPQUFPO2FBQ2Q7WUFDRCxHQUFHLEVBQUU7Z0JBQ0gsS0FBSyxFQUFFLDBCQUEwQjtnQkFDakMsV0FBVyxFQUFFLGdCQUFnQjtnQkFDN0IsSUFBSSxFQUFFLEtBQUs7YUFDWjtZQUNELFNBQVMsRUFBRTtnQkFDVCxLQUFLLEVBQUUsOEJBQThCO2dCQUNyQyxXQUFXLEVBQUUsZUFBZTtnQkFDNUIsSUFBSSxFQUFFLFlBQVk7YUFDbkI7WUFDRCwyQ0FBMkM7WUFDM0MsT0FBTyxFQUFFO2dCQUNQLEtBQUssRUFBRSw0RkFBNEY7Z0JBQ25HLFdBQVcsRUFBRSxvQkFBb0I7Z0JBQ2pDLElBQUksRUFBRSxTQUFTO2FBQ2hCO1lBQ0Qsc0JBQXNCO1lBQ3RCLE1BQU0sRUFBRTtnQkFDTixLQUFLLEVBQUUsdUJBQXVCO2dCQUM5QixXQUFXLEVBQUUsb0JBQW9CO2dCQUNqQyxJQUFJLEVBQUUsU0FBUzthQUNoQjtZQUNELDBDQUEwQztZQUMxQyxJQUFJLEVBQUU7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QztZQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMxQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVUsQ0FBQyxJQUFZLEVBQUUsS0FBYSxFQUFFLFdBQW1CO1FBQ3pELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUc7WUFDcEIsS0FBSztZQUNMLFdBQVc7WUFDWCxJQUFJO1NBQ0wsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILGFBQWEsQ0FBQyxJQUFZO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXO1FBQ1QseUJBQVksSUFBSSxDQUFDLFFBQVEsRUFBRztJQUM5QixDQUFDO0NBQ0YsQ0FBQTtBQS9LWSxrREFBbUI7OEJBQW5CLG1CQUFtQjtJQUQvQixJQUFBLG1CQUFVLEdBQUU7R0FDQSxtQkFBbUIsQ0ErSy9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy92YWRpbS9Qcm9qZWN0cy9WaXNBUEkvYXBwcy9iYWNrZW5kL3NyYy9sb2dzL3NlcnZpY2VzL3BpaS1yZWRhY3Rpb24uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFBpaVJlZGFjdGlvblJlc3VsdCB7XG4gIHRleHQ6IHN0cmluZztcbiAgcGlpRm91bmQ6IGJvb2xlYW47XG4gIHJlZGFjdGVkRmllbGRzOiBzdHJpbmdbXTtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBpaVJlZGFjdGlvblNlcnZpY2Uge1xuICAvLyBQSUkgZGV0ZWN0aW9uIHBhdHRlcm5zIC0gb3JkZXJlZCBieSBzcGVjaWZpY2l0eSB0byBhdm9pZCBjb25mbGljdHNcbiAgcHJpdmF0ZSByZWFkb25seSBwYXR0ZXJucyA9IHtcbiAgICAvLyBQcm9jZXNzIGNyZWRpdCBjYXJkcyBmaXJzdCAobW9yZSBzcGVjaWZpYylcbiAgICBjcmVkaXRDYXJkOiB7XG4gICAgICByZWdleDogL1xcYig/OlxcZHs0fVstLlxcc10/KXszfVxcZHs0fVxcYi9nLFxuICAgICAgcmVwbGFjZW1lbnQ6ICdbQ0FSRF9SRURBQ1RFRF0nLFxuICAgICAgbmFtZTogJ2NyZWRpdF9jYXJkJ1xuICAgIH0sXG4gICAgLy8gUHJvY2VzcyBwaG9uZSBudW1iZXJzIGFmdGVyIGNyZWRpdCBjYXJkcyAobGVzcyBzcGVjaWZpYylcbiAgICBwaG9uZToge1xuICAgICAgcmVnZXg6IC8oXFxzfF4pKFxcKz8xP1stLlxcc10/KT9cXCg/XFxkezN9XFwpP1stLlxcc10/XFxkezN9Wy0uXFxzXT9cXGR7NH1cXGIvZyxcbiAgICAgIHJlcGxhY2VtZW50OiAnJDFbUEhPTkVfUkVEQUNURURdJyxcbiAgICAgIG5hbWU6ICdwaG9uZV9udW1iZXInXG4gICAgfSxcbiAgICBlbWFpbDoge1xuICAgICAgcmVnZXg6IC9bYS16QS1aMC05Ll8lKy1dK0BbYS16QS1aMC05Li1dK1xcLlthLXpBLVpdezIsfS9nLFxuICAgICAgcmVwbGFjZW1lbnQ6ICdbRU1BSUxfUkVEQUNURURdJyxcbiAgICAgIG5hbWU6ICdlbWFpbCdcbiAgICB9LFxuICAgIHNzbjoge1xuICAgICAgcmVnZXg6IC9cXGJcXGR7M30tP1xcZHsyfS0/XFxkezR9XFxiL2csXG4gICAgICByZXBsYWNlbWVudDogJ1tTU05fUkVEQUNURURdJyxcbiAgICAgIG5hbWU6ICdzc24nXG4gICAgfSxcbiAgICBpcEFkZHJlc3M6IHtcbiAgICAgIHJlZ2V4OiAvXFxiKD86XFxkezEsM31cXC4pezN9XFxkezEsM31cXGIvZyxcbiAgICAgIHJlcGxhY2VtZW50OiAnW0lQX1JFREFDVEVEXScsXG4gICAgICBuYW1lOiAnaXBfYWRkcmVzcydcbiAgICB9LFxuICAgIC8vIEdlbmVyaWMgcGF0dGVybnMgZm9yIGNvbW1vbiBQSUkga2V5d29yZHNcbiAgICBhZGRyZXNzOiB7XG4gICAgICByZWdleDogL1xcYlxcZCtcXHMrW0EtWmEtelxcc10rKD86c3RyZWV0fHN0fGF2ZW51ZXxhdmV8cm9hZHxyZHxkcml2ZXxkcnxsYW5lfGxufGNvdXJ0fGN0fHBsYWNlfHBsKVxcYi9naSxcbiAgICAgIHJlcGxhY2VtZW50OiAnW0FERFJFU1NfUkVEQUNURURdJyxcbiAgICAgIG5hbWU6ICdhZGRyZXNzJ1xuICAgIH0sXG4gICAgLy8gQVBJIGtleXMgYW5kIHRva2Vuc1xuICAgIGFwaUtleToge1xuICAgICAgcmVnZXg6IC9cXGJbQS1aYS16MC05XXszMix9XFxiL2csXG4gICAgICByZXBsYWNlbWVudDogJ1tBUElfS0VZX1JFREFDVEVEXScsXG4gICAgICBuYW1lOiAnYXBpX2tleSdcbiAgICB9LFxuICAgIC8vIFVVSURzIChwb3RlbnRpYWwgc2Vuc2l0aXZlIGlkZW50aWZpZXJzKVxuICAgIHV1aWQ6IHtcbiAgICAgIHJlZ2V4OiAvXFxiWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9XFxiL2dpLFxuICAgICAgcmVwbGFjZW1lbnQ6ICdbVVVJRF9SRURBQ1RFRF0nLFxuICAgICAgbmFtZTogJ3V1aWQnXG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBSZWRhY3QgUElJIGZyb20gdGV4dCBjb250ZW50XG4gICAqL1xuICByZWRhY3RQaWkodGV4dDogc3RyaW5nKTogUGlpUmVkYWN0aW9uUmVzdWx0IHtcbiAgICBpZiAoIXRleHQgfHwgdHlwZW9mIHRleHQgIT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0ZXh0OiAnJyxcbiAgICAgICAgcGlpRm91bmQ6IGZhbHNlLFxuICAgICAgICByZWRhY3RlZEZpZWxkczogW11cbiAgICAgIH07XG4gICAgfVxuXG4gICAgbGV0IHJlZGFjdGVkVGV4dCA9IHRleHQ7XG4gICAgY29uc3QgcmVkYWN0ZWRGaWVsZHM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBBcHBseSBlYWNoIHBhdHRlcm5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHBhdHRlcm5dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucGF0dGVybnMpKSB7XG4gICAgICBjb25zdCBtYXRjaGVzID0gcmVkYWN0ZWRUZXh0Lm1hdGNoKHBhdHRlcm4ucmVnZXgpO1xuICAgICAgaWYgKG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlZGFjdGVkVGV4dCA9IHJlZGFjdGVkVGV4dC5yZXBsYWNlKHBhdHRlcm4ucmVnZXgsIHBhdHRlcm4ucmVwbGFjZW1lbnQpO1xuICAgICAgICByZWRhY3RlZEZpZWxkcy5wdXNoKHBhdHRlcm4ubmFtZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6IHJlZGFjdGVkVGV4dCxcbiAgICAgIHBpaUZvdW5kOiByZWRhY3RlZEZpZWxkcy5sZW5ndGggPiAwLFxuICAgICAgcmVkYWN0ZWRGaWVsZHNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZGFjdCBQSUkgZnJvbSBhbiBvYmplY3QgKHJlY3Vyc2l2ZWx5KVxuICAgKi9cbiAgcmVkYWN0UGlpRnJvbU9iamVjdChvYmo6IGFueSk6IHsgb2JqOiBhbnk7IHBpaUZvdW5kOiBib29sZWFuOyByZWRhY3RlZEZpZWxkczogc3RyaW5nW10gfSB7XG4gICAgaWYgKCFvYmogfHwgdHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHtcbiAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlZGFjdFBpaShvYmopO1xuICAgICAgICByZXR1cm4geyBvYmo6IHJlc3VsdC50ZXh0LCBwaWlGb3VuZDogcmVzdWx0LnBpaUZvdW5kLCByZWRhY3RlZEZpZWxkczogcmVzdWx0LnJlZGFjdGVkRmllbGRzIH07XG4gICAgICB9XG4gICAgICByZXR1cm4geyBvYmosIHBpaUZvdW5kOiBmYWxzZSwgcmVkYWN0ZWRGaWVsZHM6IFtdIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVkYWN0ZWRPYmogPSBBcnJheS5pc0FycmF5KG9iaikgPyBbXSA6IHt9O1xuICAgIGxldCBnbG9iYWxQaWlGb3VuZCA9IGZhbHNlO1xuICAgIGNvbnN0IGdsb2JhbFJlZGFjdGVkRmllbGRzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSkge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZWRhY3RQaWkodmFsdWUpO1xuICAgICAgICByZWRhY3RlZE9ialtrZXldID0gcmVzdWx0LnRleHQ7XG4gICAgICAgIGlmIChyZXN1bHQucGlpRm91bmQpIHtcbiAgICAgICAgICBnbG9iYWxQaWlGb3VuZCA9IHRydWU7XG4gICAgICAgICAgZ2xvYmFsUmVkYWN0ZWRGaWVsZHMucHVzaCguLi5yZXN1bHQucmVkYWN0ZWRGaWVsZHMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZWRhY3RQaWlGcm9tT2JqZWN0KHZhbHVlKTtcbiAgICAgICAgcmVkYWN0ZWRPYmpba2V5XSA9IHJlc3VsdC5vYmo7XG4gICAgICAgIGlmIChyZXN1bHQucGlpRm91bmQpIHtcbiAgICAgICAgICBnbG9iYWxQaWlGb3VuZCA9IHRydWU7XG4gICAgICAgICAgZ2xvYmFsUmVkYWN0ZWRGaWVsZHMucHVzaCguLi5yZXN1bHQucmVkYWN0ZWRGaWVsZHMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWRhY3RlZE9ialtrZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG9iajogcmVkYWN0ZWRPYmosXG4gICAgICBwaWlGb3VuZDogZ2xvYmFsUGlpRm91bmQsXG4gICAgICByZWRhY3RlZEZpZWxkczogWy4uLm5ldyBTZXQoZ2xvYmFsUmVkYWN0ZWRGaWVsZHMpXVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdGV4dCBjb250YWlucyBQSUkgd2l0aG91dCByZWRhY3RpbmdcbiAgICovXG4gIGNvbnRhaW5zUGlpKHRleHQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmICghdGV4dCB8fCB0eXBlb2YgdGV4dCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLnBhdHRlcm5zKS5zb21lKHBhdHRlcm4gPT4gXG4gICAgICBwYXR0ZXJuLnJlZ2V4LnRlc3QodGV4dClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBQSUkgZGV0ZWN0aW9uIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldFBpaVN0YXRzKHRleHQ6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICAgIGNvbnN0IHN0YXRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHBhdHRlcm5dIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucGF0dGVybnMpKSB7XG4gICAgICBjb25zdCBtYXRjaGVzID0gdGV4dC5tYXRjaChwYXR0ZXJuLnJlZ2V4KTtcbiAgICAgIHN0YXRzW3BhdHRlcm4ubmFtZV0gPSBtYXRjaGVzID8gbWF0Y2hlcy5sZW5ndGggOiAwO1xuICAgIH1cblxuICAgIHJldHVybiBzdGF0cztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgY3VzdG9tIFBJSSBwYXR0ZXJuXG4gICAqL1xuICBhZGRQYXR0ZXJuKG5hbWU6IHN0cmluZywgcmVnZXg6IFJlZ0V4cCwgcmVwbGFjZW1lbnQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMucGF0dGVybnNbbmFtZV0gPSB7XG4gICAgICByZWdleCxcbiAgICAgIHJlcGxhY2VtZW50LFxuICAgICAgbmFtZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIFBJSSBwYXR0ZXJuXG4gICAqL1xuICByZW1vdmVQYXR0ZXJuKG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLnBhdHRlcm5zW25hbWVdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwgY29uZmlndXJlZCBwYXR0ZXJuc1xuICAgKi9cbiAgZ2V0UGF0dGVybnMoKTogUmVjb3JkPHN0cmluZywgeyByZWdleDogUmVnRXhwOyByZXBsYWNlbWVudDogc3RyaW5nOyBuYW1lOiBzdHJpbmcgfT4ge1xuICAgIHJldHVybiB7IC4uLnRoaXMucGF0dGVybnMgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==