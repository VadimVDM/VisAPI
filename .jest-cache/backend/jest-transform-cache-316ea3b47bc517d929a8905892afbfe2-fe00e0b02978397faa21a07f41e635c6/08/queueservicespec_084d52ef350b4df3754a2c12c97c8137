07d443d74966e2170a3ef5e334260ff7
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const testing_1 = require("@nestjs/testing");
const bullmq_1 = require("@nestjs/bullmq");
const queue_service_1 = require("./queue.service");
const core_config_1 = require("@visapi/core-config");
const shared_types_1 = require("@visapi/shared-types");
describe('QueueService', () => {
    let service;
    let criticalQueue;
    let defaultQueue;
    let bulkQueue;
    const createMockQueue = () => ({
        add: jest.fn(),
        getJob: jest.fn(),
        getJobCounts: jest.fn(),
        clean: jest.fn(),
        pause: jest.fn(),
        resume: jest.fn(),
        drain: jest.fn(),
        remove: jest.fn(),
    });
    beforeEach(() => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        const mockCriticalQueue = createMockQueue();
        const mockDefaultQueue = createMockQueue();
        const mockBulkQueue = createMockQueue();
        const module = yield testing_1.Test.createTestingModule({
            providers: [
                queue_service_1.QueueService,
                {
                    provide: (0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.CRITICAL),
                    useValue: mockCriticalQueue,
                },
                {
                    provide: (0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.DEFAULT),
                    useValue: mockDefaultQueue,
                },
                {
                    provide: (0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.BULK),
                    useValue: mockBulkQueue,
                },
                {
                    provide: core_config_1.ConfigService,
                    useValue: {
                        queueMaxRetries: 3,
                        queueRetryDelay: 2000,
                    },
                },
            ],
        }).compile();
        service = module.get(queue_service_1.QueueService);
        criticalQueue = module.get((0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.CRITICAL));
        defaultQueue = module.get((0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.DEFAULT));
        bulkQueue = module.get((0, bullmq_1.getQueueToken)(shared_types_1.QUEUE_NAMES.BULK));
    }));
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('addJob', () => {
        it('should add job to default queue with correct data', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const jobData = {
                channel: '#general',
                message: 'Test message',
                template: 'visa_approved',
                variables: { name: 'John Doe' },
            };
            const mockJob = { id: 'job-123' };
            defaultQueue.add.mockResolvedValue(mockJob);
            const result = yield service.addJob(shared_types_1.QUEUE_NAMES.DEFAULT, 'slack.send', jobData);
            expect(result).toBe(mockJob);
            expect(defaultQueue.add).toHaveBeenCalledWith('slack.send', jobData, expect.objectContaining({
                attempts: 3,
                backoff: {
                    type: 'exponential',
                    delay: 2000,
                },
                removeOnComplete: true,
                removeOnFail: false,
            }));
        }));
        it('should add job to critical queue when specified', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const jobData = { message: 'Critical notification' };
            const mockJob = { id: 'job-456' };
            criticalQueue.add.mockResolvedValue(mockJob);
            const result = yield service.addJob(shared_types_1.QUEUE_NAMES.CRITICAL, 'notification.send', jobData);
            expect(result).toBe(mockJob);
            expect(criticalQueue.add).toHaveBeenCalledWith('notification.send', jobData, expect.any(Object));
        }));
    });
    describe('getJob', () => {
        it('should get job from specified queue', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const mockJob = { id: 'job-123', data: { test: true } };
            defaultQueue.getJob.mockResolvedValue(mockJob);
            const result = yield service.getJob(shared_types_1.QUEUE_NAMES.DEFAULT, 'job-123');
            expect(result).toBe(mockJob);
            expect(defaultQueue.getJob).toHaveBeenCalledWith('job-123');
        }));
        it('should return undefined when job not found', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            defaultQueue.getJob.mockResolvedValue(undefined);
            const result = yield service.getJob(shared_types_1.QUEUE_NAMES.DEFAULT, 'non-existent');
            expect(result).toBeUndefined();
        }));
    });
    // checkHealth method was removed as it's replaced by dedicated health indicators
    describe('getQueueMetrics', () => {
        it('should return metrics for all queues', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const mockCounts = {
                waiting: 5,
                active: 2,
                completed: 100,
                failed: 3,
                delayed: 1,
            };
            criticalQueue.getJobCounts.mockResolvedValue(mockCounts);
            defaultQueue.getJobCounts.mockResolvedValue(mockCounts);
            bulkQueue.getJobCounts.mockResolvedValue(mockCounts);
            const result = yield service.getQueueMetrics();
            expect(result).toHaveLength(3);
            expect(result[0]).toEqual({
                name: shared_types_1.QUEUE_NAMES.CRITICAL,
                waiting: 5,
                active: 2,
                completed: 100,
                failed: 3,
                delayed: 1,
            });
        }));
        it('should return metrics for specific queue when specified', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const mockCounts = {
                waiting: 5,
                active: 2,
                completed: 100,
                failed: 3,
                delayed: 1,
            };
            defaultQueue.getJobCounts.mockResolvedValue(mockCounts);
            const result = yield service.getQueueMetrics(shared_types_1.QUEUE_NAMES.DEFAULT);
            expect(result).toHaveLength(1);
            expect(result[0]).toEqual({
                name: shared_types_1.QUEUE_NAMES.DEFAULT,
                waiting: 5,
                active: 2,
                completed: 100,
                failed: 3,
                delayed: 1,
            });
        }));
    });
    describe('pauseQueue', () => {
        it('should pause the specified queue', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.pauseQueue(shared_types_1.QUEUE_NAMES.DEFAULT);
            expect(defaultQueue.pause).toHaveBeenCalled();
        }));
    });
    describe('resumeQueue', () => {
        it('should resume the specified queue', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.resumeQueue(shared_types_1.QUEUE_NAMES.DEFAULT);
            expect(defaultQueue.resume).toHaveBeenCalled();
        }));
    });
    describe('drainQueue', () => {
        it('should drain the specified queue', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.drainQueue(shared_types_1.QUEUE_NAMES.DEFAULT);
            expect(defaultQueue.drain).toHaveBeenCalled();
        }));
    });
    describe('cleanQueue', () => {
        it('should clean the specified queue', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const mockResult = ['job-1', 'job-2'];
            defaultQueue.clean.mockResolvedValue(mockResult);
            const result = yield service.cleanQueue(shared_types_1.QUEUE_NAMES.DEFAULT, 5000, 10, 'completed');
            expect(result).toBe(mockResult);
            expect(defaultQueue.clean).toHaveBeenCalledWith(5000, 10, 'completed');
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL3F1ZXVlL3F1ZXVlLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBc0Q7QUFDdEQsMkNBQStDO0FBQy9DLG1EQUErQztBQUMvQyxxREFBb0Q7QUFDcEQsdURBQW1EO0FBR25ELFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzVCLElBQUksT0FBcUIsQ0FBQztJQUMxQixJQUFJLGFBQWlDLENBQUM7SUFDdEMsSUFBSSxZQUFnQyxDQUFDO0lBQ3JDLElBQUksU0FBNkIsQ0FBQztJQUVsQyxNQUFNLGVBQWUsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDakIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDdkIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDaEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDbEIsQ0FBQyxDQUFDO0lBRUgsVUFBVSxDQUFDLEdBQVMsRUFBRTtRQUNwQixNQUFNLGlCQUFpQixHQUFHLGVBQWUsRUFBRSxDQUFDO1FBQzVDLE1BQU0sZ0JBQWdCLEdBQUcsZUFBZSxFQUFFLENBQUM7UUFDM0MsTUFBTSxhQUFhLEdBQUcsZUFBZSxFQUFFLENBQUM7UUFFeEMsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCw0QkFBWTtnQkFDWjtvQkFDRSxPQUFPLEVBQUUsSUFBQSxzQkFBYSxFQUFDLDBCQUFXLENBQUMsUUFBUSxD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QUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO1FBQzFCLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFTLEVBQUU7WUFDaEQsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLDBCQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFOUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2hELENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO1FBQzFCLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFTLEVBQUU7WUFDaEQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDdEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVqRCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUMsMEJBQVcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUVwRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN6RSxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvdmFkaW0vUHJvamVjdHMvVmlzQVBJL2FwcHMvYmFja2VuZC9zcmMvcXVldWUvcXVldWUuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgZ2V0UXVldWVUb2tlbiB9IGZyb20gJ0BuZXN0anMvYnVsbG1xJztcbmltcG9ydCB7IFF1ZXVlU2VydmljZSB9IGZyb20gJy4vcXVldWUuc2VydmljZSc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQHZpc2FwaS9jb3JlLWNvbmZpZyc7XG5pbXBvcnQgeyBRVUVVRV9OQU1FUyB9IGZyb20gJ0B2aXNhcGkvc2hhcmVkLXR5cGVzJztcbmltcG9ydCB7IFF1ZXVlLCBKb2IgfSBmcm9tICdidWxsbXEnO1xuXG5kZXNjcmliZSgnUXVldWVTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUXVldWVTZXJ2aWNlO1xuICBsZXQgY3JpdGljYWxRdWV1ZTogamVzdC5Nb2NrZWQ8UXVldWU+O1xuICBsZXQgZGVmYXVsdFF1ZXVlOiBqZXN0Lk1vY2tlZDxRdWV1ZT47XG4gIGxldCBidWxrUXVldWU6IGplc3QuTW9ja2VkPFF1ZXVlPjtcblxuICBjb25zdCBjcmVhdGVNb2NrUXVldWUgPSAoKSA9PiAoe1xuICAgIGFkZDogamVzdC5mbigpLFxuICAgIGdldEpvYjogamVzdC5mbigpLFxuICAgIGdldEpvYkNvdW50czogamVzdC5mbigpLFxuICAgIGNsZWFuOiBqZXN0LmZuKCksXG4gICAgcGF1c2U6IGplc3QuZm4oKSxcbiAgICByZXN1bWU6IGplc3QuZm4oKSxcbiAgICBkcmFpbjogamVzdC5mbigpLFxuICAgIHJlbW92ZTogamVzdC5mbigpLFxuICB9KTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrQ3JpdGljYWxRdWV1ZSA9IGNyZWF0ZU1vY2tRdWV1ZSgpO1xuICAgIGNvbnN0IG1vY2tEZWZhdWx0UXVldWUgPSBjcmVhdGVNb2NrUXVldWUoKTtcbiAgICBjb25zdCBtb2NrQnVsa1F1ZXVlID0gY3JlYXRlTW9ja1F1ZXVlKCk7XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFF1ZXVlU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IGdldFF1ZXVlVG9rZW4oUVVFVUVfTkFNRVMuQ1JJVElDQUwpLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQ3JpdGljYWxRdWV1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IGdldFF1ZXVlVG9rZW4oUVVFVUVfTkFNRVMuREVGQVVMVCksXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tEZWZhdWx0UXVldWUsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBnZXRRdWV1ZVRva2VuKFFVRVVFX05BTUVTLkJVTEspLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQnVsa1F1ZXVlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgcXVldWVNYXhSZXRyaWVzOiAzLFxuICAgICAgICAgICAgcXVldWVSZXRyeURlbGF5OiAyMDAwLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PFF1ZXVlU2VydmljZT4oUXVldWVTZXJ2aWNlKTtcbiAgICBjcml0aWNhbFF1ZXVlID0gbW9kdWxlLmdldChnZXRRdWV1ZVRva2VuKFFVRVVFX05BTUVTLkNSSVRJQ0FMKSk7XG4gICAgZGVmYXVsdFF1ZXVlID0gbW9kdWxlLmdldChnZXRRdWV1ZVRva2VuKFFVRVVFX05BTUVTLkRFRkFVTFQpKTtcbiAgICBidWxrUXVldWUgPSBtb2R1bGUuZ2V0KGdldFF1ZXVlVG9rZW4oUVVFVUVfTkFNRVMuQlVMSykpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhZGRKb2InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhZGQgam9iIHRvIGRlZmF1bHQgcXVldWUgd2l0aCBjb3JyZWN0IGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBqb2JEYXRhID0ge1xuICAgICAgICBjaGFubmVsOiAnI2dlbmVyYWwnLFxuICAgICAgICBtZXNzYWdlOiAnVGVzdCBtZXNzYWdlJyxcbiAgICAgICAgdGVtcGxhdGU6ICd2aXNhX2FwcHJvdmVkJyxcbiAgICAgICAgdmFyaWFibGVzOiB7IG5hbWU6ICdKb2huIERvZScgfSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1vY2tKb2IgPSB7IGlkOiAnam9iLTEyMycgfSBhcyBKb2I7XG4gICAgICBkZWZhdWx0UXVldWUuYWRkLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tKb2IpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmFkZEpvYihRVUVVRV9OQU1FUy5ERUZBVUxULCAnc2xhY2suc2VuZCcsIGpvYkRhdGEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKG1vY2tKb2IpO1xuICAgICAgZXhwZWN0KGRlZmF1bHRRdWV1ZS5hZGQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnc2xhY2suc2VuZCcsXG4gICAgICAgIGpvYkRhdGEsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICBiYWNrb2ZmOiB7XG4gICAgICAgICAgICB0eXBlOiAnZXhwb25lbnRpYWwnLFxuICAgICAgICAgICAgZGVsYXk6IDIwMDAsXG4gICAgICAgICAgfSxcbiAgICAgICAgICByZW1vdmVPbkNvbXBsZXRlOiB0cnVlLFxuICAgICAgICAgIHJlbW92ZU9uRmFpbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhZGQgam9iIHRvIGNyaXRpY2FsIHF1ZXVlIHdoZW4gc3BlY2lmaWVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgam9iRGF0YSA9IHsgbWVzc2FnZTogJ0NyaXRpY2FsIG5vdGlmaWNhdGlvbicgfTtcbiAgICAgIGNvbnN0IG1vY2tKb2IgPSB7IGlkOiAnam9iLTQ1NicgfSBhcyBKb2I7XG4gICAgICBjcml0aWNhbFF1ZXVlLmFkZC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrSm9iKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5hZGRKb2IoUVVFVUVfTkFNRVMuQ1JJVElDQUwsICdub3RpZmljYXRpb24uc2VuZCcsIGpvYkRhdGEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKG1vY2tKb2IpO1xuICAgICAgZXhwZWN0KGNyaXRpY2FsUXVldWUuYWRkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ25vdGlmaWNhdGlvbi5zZW5kJyxcbiAgICAgICAgam9iRGF0YSxcbiAgICAgICAgZXhwZWN0LmFueShPYmplY3QpXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0Sm9iJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2V0IGpvYiBmcm9tIHNwZWNpZmllZCBxdWV1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tKb2IgPSB7IGlkOiAnam9iLTEyMycsIGRhdGE6IHsgdGVzdDogdHJ1ZSB9IH0gYXMgSm9iO1xuICAgICAgZGVmYXVsdFF1ZXVlLmdldEpvYi5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrSm9iKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5nZXRKb2IoUVVFVUVfTkFNRVMuREVGQVVMVCwgJ2pvYi0xMjMnKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShtb2NrSm9iKTtcbiAgICAgIGV4cGVjdChkZWZhdWx0UXVldWUuZ2V0Sm9iKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnam9iLTEyMycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdW5kZWZpbmVkIHdoZW4gam9iIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGRlZmF1bHRRdWV1ZS5nZXRKb2IubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5nZXRKb2IoUVVFVUVfTkFNRVMuREVGQVVMVCwgJ25vbi1leGlzdGVudCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIGNoZWNrSGVhbHRoIG1ldGhvZCB3YXMgcmVtb3ZlZCBhcyBpdCdzIHJlcGxhY2VkIGJ5IGRlZGljYXRlZCBoZWFsdGggaW5kaWNhdG9yc1xuXG4gIGRlc2NyaWJlKCdnZXRRdWV1ZU1ldHJpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbWV0cmljcyBmb3IgYWxsIHF1ZXVlcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tDb3VudHMgPSB7XG4gICAgICAgIHdhaXRpbmc6IDUsXG4gICAgICAgIGFjdGl2ZTogMixcbiAgICAgICAgY29tcGxldGVkOiAxMDAsXG4gICAgICAgIGZhaWxlZDogMyxcbiAgICAgICAgZGVsYXllZDogMSxcbiAgICAgIH07XG5cbiAgICAgIGNyaXRpY2FsUXVldWUuZ2V0Sm9iQ291bnRzLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDb3VudHMpO1xuICAgICAgZGVmYXVsdFF1ZXVlLmdldEpvYkNvdW50cy5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ291bnRzKTtcbiAgICAgIGJ1bGtRdWV1ZS5nZXRKb2JDb3VudHMubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NvdW50cyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ2V0UXVldWVNZXRyaWNzKCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICAgIGV4cGVjdChyZXN1bHRbMF0pLnRvRXF1YWwoe1xuICAgICAgICBuYW1lOiBRVUVVRV9OQU1FUy5DUklUSUNBTCxcbiAgICAgICAgd2FpdGluZzogNSxcbiAgICAgICAgYWN0aXZlOiAyLFxuICAgICAgICBjb21wbGV0ZWQ6IDEwMCxcbiAgICAgICAgZmFpbGVkOiAzLFxuICAgICAgICBkZWxheWVkOiAxLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBtZXRyaWNzIGZvciBzcGVjaWZpYyBxdWV1ZSB3aGVuIHNwZWNpZmllZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tDb3VudHMgPSB7XG4gICAgICAgIHdhaXRpbmc6IDUsXG4gICAgICAgIGFjdGl2ZTogMixcbiAgICAgICAgY29tcGxldGVkOiAxMDAsXG4gICAgICAgIGZhaWxlZDogMyxcbiAgICAgICAgZGVsYXllZDogMSxcbiAgICAgIH07XG5cbiAgICAgIGRlZmF1bHRRdWV1ZS5nZXRKb2JDb3VudHMubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NvdW50cyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ2V0UXVldWVNZXRyaWNzKFFVRVVFX05BTUVTLkRFRkFVTFQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QocmVzdWx0WzBdKS50b0VxdWFsKHtcbiAgICAgICAgbmFtZTogUVVFVUVfTkFNRVMuREVGQVVMVCxcbiAgICAgICAgd2FpdGluZzogNSxcbiAgICAgICAgYWN0aXZlOiAyLFxuICAgICAgICBjb21wbGV0ZWQ6IDEwMCxcbiAgICAgICAgZmFpbGVkOiAzLFxuICAgICAgICBkZWxheWVkOiAxLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdwYXVzZVF1ZXVlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcGF1c2UgdGhlIHNwZWNpZmllZCBxdWV1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UucGF1c2VRdWV1ZShRVUVVRV9OQU1FUy5ERUZBVUxUKTtcblxuICAgICAgZXhwZWN0KGRlZmF1bHRRdWV1ZS5wYXVzZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVzdW1lUXVldWUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXN1bWUgdGhlIHNwZWNpZmllZCBxdWV1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UucmVzdW1lUXVldWUoUVVFVUVfTkFNRVMuREVGQVVMVCk7XG5cbiAgICAgIGV4cGVjdChkZWZhdWx0UXVldWUucmVzdW1lKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdkcmFpblF1ZXVlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZHJhaW4gdGhlIHNwZWNpZmllZCBxdWV1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UuZHJhaW5RdWV1ZShRVUVVRV9OQU1FUy5ERUZBVUxUKTtcblxuICAgICAgZXhwZWN0KGRlZmF1bHRRdWV1ZS5kcmFpbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2xlYW5RdWV1ZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNsZWFuIHRoZSBzcGVjaWZpZWQgcXVldWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrUmVzdWx0ID0gWydqb2ItMScsICdqb2ItMiddO1xuICAgICAgZGVmYXVsdFF1ZXVlLmNsZWFuLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tSZXN1bHQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmNsZWFuUXVldWUoUVVFVUVfTkFNRVMuREVGQVVMVCwgNTAwMCwgMTAsICdjb21wbGV0ZWQnKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShtb2NrUmVzdWx0KTtcbiAgICAgIGV4cGVjdChkZWZhdWx0UXVldWUuY2xlYW4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDUwMDAsIDEwLCAnY29tcGxldGVkJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=