aa79dbf9ae5a1d0ffa32e495b2f7f455
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const testing_1 = require("@nestjs/testing");
const axios_1 = require("@nestjs/axios");
const core_config_1 = require("@visapi/core-config");
const slack_service_1 = require("./slack.service");
const rxjs_1 = require("rxjs");
describe('SlackService', () => {
    let service;
    let httpService;
    let configService;
    const mockPayload = {
        dashboardId: 1,
        evalMatches: [
            {
                value: 75.5,
                metric: 'cpu_usage',
                tags: { host: 'server-1' },
            },
        ],
        message: 'CPU usage is above threshold',
        orgId: 1,
        panelId: 2,
        ruleId: 3,
        ruleName: 'High CPU Usage',
        ruleUrl: 'https://grafana.example.com/d/dashboard/panel',
        state: 'alerting',
        tags: { severity: 'high' },
        title: 'High CPU Usage Alert',
    };
    beforeEach(() => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        const module = yield testing_1.Test.createTestingModule({
            providers: [
                slack_service_1.SlackService,
                {
                    provide: axios_1.HttpService,
                    useValue: {
                        post: jest.fn().mockReturnValue((0, rxjs_1.of)({ data: { ok: true } })),
                    },
                },
                {
                    provide: core_config_1.ConfigService,
                    useValue: {
                        slackEnabled: true,
                        slackWebhookUrl: 'https://hooks.slack.com/services/test/webhook',
                        slackDefaultChannel: '#alerts',
                        slackSigningSecret: 'test-secret',
                    },
                },
                {
                    provide: `PinoLogger:${slack_service_1.SlackService.name}`,
                    useValue: {
                        debug: jest.fn(),
                        info: jest.fn(),
                        error: jest.fn(),
                        warn: jest.fn(),
                    },
                },
            ],
        }).compile();
        service = module.get(slack_service_1.SlackService);
        httpService = module.get(axios_1.HttpService);
        configService = module.get(core_config_1.ConfigService);
    }));
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('sendGrafanaAlert', () => {
        it('should send Grafana alert successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.sendGrafanaAlert(mockPayload);
            expect(httpService.post).toHaveBeenCalledWith('https://hooks.slack.com/services/test/webhook', expect.objectContaining({
                channel: '#alerts',
                username: 'VisAPI Monitoring',
                icon_emoji: ':chart_with_upwards_trend:',
                text: expect.stringContaining('ALERTING'),
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'danger',
                        title: 'High CPU Usage',
                        title_link: 'https://grafana.example.com/d/dashboard/panel',
                        text: 'CPU usage is above threshold',
                    }),
                ]),
            }), expect.objectContaining({
                headers: {
                    'Content-Type': 'application/json',
                },
                timeout: 10000,
            }));
        }));
        it('should skip alert when Slack is disabled', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            // Mock disabled
            configService.slackEnabled = false;
            yield service.sendGrafanaAlert(mockPayload);
            expect(httpService.post).not.toHaveBeenCalled();
        }));
        it('should handle missing webhook URL', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            // Mock empty webhook URL
            configService.slackWebhookUrl = '';
            yield service.sendGrafanaAlert(mockPayload);
            expect(httpService.post).not.toHaveBeenCalled();
        }));
        it('should handle HTTP errors', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const error = new Error('Network error');
            httpService.post.mockReturnValue((0, rxjs_1.throwError)(error));
            yield expect(service.sendGrafanaAlert(mockPayload)).rejects.toThrow('Network error');
        }));
        it('should format resolved alert correctly', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const resolvedPayload = Object.assign(Object.assign({}, mockPayload), { state: 'ok', message: 'CPU usage is back to normal' });
            yield service.sendGrafanaAlert(resolvedPayload);
            expect(httpService.post).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
                text: expect.stringContaining('OK'),
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'good',
                        pretext: expect.stringContaining('OK Alert'),
                    }),
                ]),
            }), expect.any(Object));
        }));
    });
    describe('sendCustomAlert', () => {
        it('should send custom alert successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.sendCustomAlert('Test message', 'warning', '#test');
            expect(httpService.post).toHaveBeenCalledWith('https://hooks.slack.com/services/test/webhook', expect.objectContaining({
                channel: '#test',
                username: 'VisAPI System',
                icon_emoji: ':robot_face:',
                text: ':warning: Test message',
                attachments: expect.arrayContaining([
                    expect.objectContaining({
                        color: 'warning',
                        text: 'Test message',
                    }),
                ]),
            }), expect.objectContaining({
                headers: {
                    'Content-Type': 'application/json',
                },
                timeout: 10000,
            }));
        }));
        it('should use default channel when none specified', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield service.sendCustomAlert('Test message');
            expect(httpService.post).toHaveBeenCalledWith(expect.any(String), expect.objectContaining({
                channel: '#alerts',
            }), expect.any(Object));
        }));
        it('should handle errors gracefully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const error = new Error('Network error');
            httpService.post.mockReturnValue((0, rxjs_1.throwError)(error));
            yield expect(service.sendCustomAlert('Test message')).rejects.toThrow('Network error');
        }));
    });
    describe('validateWebhookSignature', () => {
        it('should return true for valid signature', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const payload = '{"test": "data"}';
            const timestamp = '1234567890';
            const crypto = require('crypto');
            const signature = 'v0=' + crypto
                .createHmac('sha256', 'test-secret')
                .update(`v0:${timestamp}:${payload}`)
                .digest('hex');
            const result = yield service.validateWebhookSignature(payload, timestamp, signature);
            expect(result).toBe(true);
        }));
        it('should return false for invalid signature', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const payload = '{"test": "data"}';
            const timestamp = '1234567890';
            const signature = 'v0=invalid_signature';
            const result = yield service.validateWebhookSignature(payload, timestamp, signature);
            expect(result).toBe(false);
        }));
        it('should return true when no signing secret is configured', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            configService.slackSigningSecret = '';
            const result = yield service.validateWebhookSignature('payload', '123', 'sig');
            expect(result).toBe(true);
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL25vdGlmaWNhdGlvbnMvc2xhY2suc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFzRDtBQUN0RCx5Q0FBNEM7QUFDNUMscURBQW9EO0FBQ3BELG1EQUErQztBQUUvQywrQkFBc0M7QUFHdEMsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsSUFBSSxPQUFxQixDQUFDO0lBQzFCLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLGFBQTRCLENBQUM7SUFFakMsTUFBTSxXQUFXLEdBQTBCO1FBQ3pDLFdBQVcsRUFBRSxDQUFDO1FBQ2QsV0FBVyxFQUFFO1lBQ1g7Z0JBQ0UsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsTUFBTSxFQUFFLFdBQVc7Z0JBQ25CLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUU7YUFDM0I7U0FDRjtRQUNELE9BQU8sRUFBRSw4QkFBOEI7UUFDdkMsS0FBSyxFQUFFLENBQUM7UUFDUixPQUFPLEVBQUUsQ0FBQztRQUNWLE1BQU0sRUFBRSxDQUFDO1FBQ1QsUUFBUSxFQUFFLGdCQUFnQjtRQUMxQixPQUFPLEVBQUUsK0NBQStDO1FBQ3hELEtBQUssRUFBRSxVQUFVO1FBQ2pCLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7UUFDMUIsS0FBSyxFQUFFLHNCQUFzQjtLQUM5QixDQUFDO0lBRUYsVUFBVSxDQUFDLEdBQVMsRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULDRCQUFZO2dCQUNaO29CQUNFLE9BQU8sRUFBRSxtQkFBVztvQkFDcEIsUUFBUSxFQUFFO3dCQUNSLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLElBQUEsU0FBRSxFQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLElB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QyxDQUFDO1FBRUgsRUFBRSxDQUFDLDJDQUEyQyxFQUFFLEdBQVMsRUFBRTtZQUN6RCxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQztZQUNuQyxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFDL0IsTUFBTSxTQUFTLEdBQUcsc0JBQXNCLENBQUM7WUFFekMsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsd0JBQXdCLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUVyRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQSxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMseURBQXlELEVBQUUsR0FBUyxFQUFFO1lBQ3ZFLGFBQWEsQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7WUFFdEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztZQUUvRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy92YWRpbS9Qcm9qZWN0cy9WaXNBUEkvYXBwcy9iYWNrZW5kL3NyYy9ub3RpZmljYXRpb25zL3NsYWNrLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IEh0dHBTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9heGlvcyc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQHZpc2FwaS9jb3JlLWNvbmZpZyc7XG5pbXBvcnQgeyBTbGFja1NlcnZpY2UgfSBmcm9tICcuL3NsYWNrLnNlcnZpY2UnO1xuaW1wb3J0IHsgR3JhZmFuYVdlYmhvb2tQYXlsb2FkIH0gZnJvbSAnQHZpc2FwaS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IHsgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBpbm9Mb2dnZXIgfSBmcm9tICduZXN0anMtcGlubyc7XG5cbmRlc2NyaWJlKCdTbGFja1NlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBTbGFja1NlcnZpY2U7XG4gIGxldCBodHRwU2VydmljZTogSHR0cFNlcnZpY2U7XG4gIGxldCBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlO1xuXG4gIGNvbnN0IG1vY2tQYXlsb2FkOiBHcmFmYW5hV2ViaG9va1BheWxvYWQgPSB7XG4gICAgZGFzaGJvYXJkSWQ6IDEsXG4gICAgZXZhbE1hdGNoZXM6IFtcbiAgICAgIHtcbiAgICAgICAgdmFsdWU6IDc1LjUsXG4gICAgICAgIG1ldHJpYzogJ2NwdV91c2FnZScsXG4gICAgICAgIHRhZ3M6IHsgaG9zdDogJ3NlcnZlci0xJyB9LFxuICAgICAgfSxcbiAgICBdLFxuICAgIG1lc3NhZ2U6ICdDUFUgdXNhZ2UgaXMgYWJvdmUgdGhyZXNob2xkJyxcbiAgICBvcmdJZDogMSxcbiAgICBwYW5lbElkOiAyLFxuICAgIHJ1bGVJZDogMyxcbiAgICBydWxlTmFtZTogJ0hpZ2ggQ1BVIFVzYWdlJyxcbiAgICBydWxlVXJsOiAnaHR0cHM6Ly9ncmFmYW5hLmV4YW1wbGUuY29tL2QvZGFzaGJvYXJkL3BhbmVsJyxcbiAgICBzdGF0ZTogJ2FsZXJ0aW5nJyxcbiAgICB0YWdzOiB7IHNldmVyaXR5OiAnaGlnaCcgfSxcbiAgICB0aXRsZTogJ0hpZ2ggQ1BVIFVzYWdlIEFsZXJ0JyxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFNsYWNrU2VydmljZSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IEh0dHBTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBwb3N0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG9mKHsgZGF0YTogeyBvazogdHJ1ZSB9IH0pKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgc2xhY2tFbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgc2xhY2tXZWJob29rVXJsOiAnaHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvdGVzdC93ZWJob29rJyxcbiAgICAgICAgICAgIHNsYWNrRGVmYXVsdENoYW5uZWw6ICcjYWxlcnRzJyxcbiAgICAgICAgICAgIHNsYWNrU2lnbmluZ1NlY3JldDogJ3Rlc3Qtc2VjcmV0JyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogYFBpbm9Mb2dnZXI6JHtTbGFja1NlcnZpY2UubmFtZX1gLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBkZWJ1ZzogamVzdC5mbigpLFxuICAgICAgICAgICAgaW5mbzogamVzdC5mbigpLFxuICAgICAgICAgICAgZXJyb3I6IGplc3QuZm4oKSxcbiAgICAgICAgICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxTbGFja1NlcnZpY2U+KFNsYWNrU2VydmljZSk7XG4gICAgaHR0cFNlcnZpY2UgPSBtb2R1bGUuZ2V0PEh0dHBTZXJ2aWNlPihIdHRwU2VydmljZSk7XG4gICAgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8Q29uZmlnU2VydmljZT4oQ29uZmlnU2VydmljZSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlbmRHcmFmYW5hQWxlcnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZW5kIEdyYWZhbmEgYWxlcnQgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5zZW5kR3JhZmFuYUFsZXJ0KG1vY2tQYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KGh0dHBTZXJ2aWNlLnBvc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvdGVzdC93ZWJob29rJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGNoYW5uZWw6ICcjYWxlcnRzJyxcbiAgICAgICAgICB1c2VybmFtZTogJ1Zpc0FQSSBNb25pdG9yaW5nJyxcbiAgICAgICAgICBpY29uX2Vtb2ppOiAnOmNoYXJ0X3dpdGhfdXB3YXJkc190cmVuZDonLFxuICAgICAgICAgIHRleHQ6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdBTEVSVElORycpLFxuICAgICAgICAgIGF0dGFjaG1lbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29sb3I6ICdkYW5nZXInLFxuICAgICAgICAgICAgICB0aXRsZTogJ0hpZ2ggQ1BVIFVzYWdlJyxcbiAgICAgICAgICAgICAgdGl0bGVfbGluazogJ2h0dHBzOi8vZ3JhZmFuYS5leGFtcGxlLmNvbS9kL2Rhc2hib2FyZC9wYW5lbCcsXG4gICAgICAgICAgICAgIHRleHQ6ICdDUFUgdXNhZ2UgaXMgYWJvdmUgdGhyZXNob2xkJyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIF0pLFxuICAgICAgICB9KSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNraXAgYWxlcnQgd2hlbiBTbGFjayBpcyBkaXNhYmxlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgZGlzYWJsZWRcbiAgICAgIGNvbmZpZ1NlcnZpY2Uuc2xhY2tFbmFibGVkID0gZmFsc2U7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEdyYWZhbmFBbGVydChtb2NrUGF5bG9hZCk7XG5cbiAgICAgIGV4cGVjdChodHRwU2VydmljZS5wb3N0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWlzc2luZyB3ZWJob29rIFVSTCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgZW1wdHkgd2ViaG9vayBVUkxcbiAgICAgIGNvbmZpZ1NlcnZpY2Uuc2xhY2tXZWJob29rVXJsID0gJyc7XG5cbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEdyYWZhbmFBbGVydChtb2NrUGF5bG9hZCk7XG5cbiAgICAgIGV4cGVjdChodHRwU2VydmljZS5wb3N0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgSFRUUCBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpO1xuICAgICAgKGh0dHBTZXJ2aWNlLnBvc3QgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUodGhyb3dFcnJvcihlcnJvcikpO1xuXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5zZW5kR3JhZmFuYUFsZXJ0KG1vY2tQYXlsb2FkKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICAnTmV0d29yayBlcnJvcidcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZvcm1hdCByZXNvbHZlZCBhbGVydCBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNvbHZlZFBheWxvYWQ6IEdyYWZhbmFXZWJob29rUGF5bG9hZCA9IHtcbiAgICAgICAgLi4ubW9ja1BheWxvYWQsXG4gICAgICAgIHN0YXRlOiAnb2snLFxuICAgICAgICBtZXNzYWdlOiAnQ1BVIHVzYWdlIGlzIGJhY2sgdG8gbm9ybWFsJyxcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEdyYWZhbmFBbGVydChyZXNvbHZlZFBheWxvYWQpO1xuXG4gICAgICBleHBlY3QoaHR0cFNlcnZpY2UucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHRleHQ6IGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdPSycpLFxuICAgICAgICAgIGF0dGFjaG1lbnRzOiBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29sb3I6ICdnb29kJyxcbiAgICAgICAgICAgICAgcHJldGV4dDogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ09LIEFsZXJ0JyksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICBdKSxcbiAgICAgICAgfSksXG4gICAgICAgIGV4cGVjdC5hbnkoT2JqZWN0KVxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlbmRDdXN0b21BbGVydCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNlbmQgY3VzdG9tIGFsZXJ0IHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2Uuc2VuZEN1c3RvbUFsZXJ0KCdUZXN0IG1lc3NhZ2UnLCAnd2FybmluZycsICcjdGVzdCcpO1xuXG4gICAgICBleHBlY3QoaHR0cFNlcnZpY2UucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdodHRwczovL2hvb2tzLnNsYWNrLmNvbS9zZXJ2aWNlcy90ZXN0L3dlYmhvb2snLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgY2hhbm5lbDogJyN0ZXN0JyxcbiAgICAgICAgICB1c2VybmFtZTogJ1Zpc0FQSSBTeXN0ZW0nLFxuICAgICAgICAgIGljb25fZW1vamk6ICc6cm9ib3RfZmFjZTonLFxuICAgICAgICAgIHRleHQ6ICc6d2FybmluZzogVGVzdCBtZXNzYWdlJyxcbiAgICAgICAgICBhdHRhY2htZW50czogZXhwZWN0LmFycmF5Q29udGFpbmluZyhbXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgIGNvbG9yOiAnd2FybmluZycsXG4gICAgICAgICAgICAgIHRleHQ6ICdUZXN0IG1lc3NhZ2UnLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSksXG4gICAgICAgIH0pLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRpbWVvdXQ6IDEwMDAwLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIGRlZmF1bHQgY2hhbm5lbCB3aGVuIG5vbmUgc3BlY2lmaWVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmljZS5zZW5kQ3VzdG9tQWxlcnQoJ1Rlc3QgbWVzc2FnZScpO1xuXG4gICAgICBleHBlY3QoaHR0cFNlcnZpY2UucG9zdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGNoYW5uZWw6ICcjYWxlcnRzJyxcbiAgICAgICAgfSksXG4gICAgICAgIGV4cGVjdC5hbnkoT2JqZWN0KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9ycyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ05ldHdvcmsgZXJyb3InKTtcbiAgICAgIChodHRwU2VydmljZS5wb3N0IGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKHRocm93RXJyb3IoZXJyb3IpKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2Uuc2VuZEN1c3RvbUFsZXJ0KCdUZXN0IG1lc3NhZ2UnKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICAnTmV0d29yayBlcnJvcidcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2YWxpZGF0ZVdlYmhvb2tTaWduYXR1cmUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBmb3IgdmFsaWQgc2lnbmF0dXJlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9ICd7XCJ0ZXN0XCI6IFwiZGF0YVwifSc7XG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSAnMTIzNDU2Nzg5MCc7XG4gICAgICBjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcbiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9ICd2MD0nICsgY3J5cHRvXG4gICAgICAgIC5jcmVhdGVIbWFjKCdzaGEyNTYnLCAndGVzdC1zZWNyZXQnKVxuICAgICAgICAudXBkYXRlKGB2MDoke3RpbWVzdGFtcH06JHtwYXlsb2FkfWApXG4gICAgICAgIC5kaWdlc3QoJ2hleCcpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnZhbGlkYXRlV2ViaG9va1NpZ25hdHVyZShwYXlsb2FkLCB0aW1lc3RhbXAsIHNpZ25hdHVyZSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3IgaW52YWxpZCBzaWduYXR1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gJ3tcInRlc3RcIjogXCJkYXRhXCJ9JztcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9ICcxMjM0NTY3ODkwJztcbiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9ICd2MD1pbnZhbGlkX3NpZ25hdHVyZSc7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudmFsaWRhdGVXZWJob29rU2lnbmF0dXJlKHBheWxvYWQsIHRpbWVzdGFtcCwgc2lnbmF0dXJlKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIHdoZW4gbm8gc2lnbmluZyBzZWNyZXQgaXMgY29uZmlndXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbmZpZ1NlcnZpY2Uuc2xhY2tTaWduaW5nU2VjcmV0ID0gJyc7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudmFsaWRhdGVXZWJob29rU2lnbmF0dXJlKCdwYXlsb2FkJywgJzEyMycsICdzaWcnKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=