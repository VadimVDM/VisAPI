f6b925c7e25eb3df0d506a8c30a7ac90
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
jest.mock('prometheus-remote-write', () => ({
    pushTimeseries: jest.fn(),
}));
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const remote_write_service_1 = require("./remote-write.service");
const prom_client_1 = require("prom-client");
const prometheus_remote_write_1 = require("prometheus-remote-write");
const mockPushTimeseries = prometheus_remote_write_1.pushTimeseries;
describe('RemoteWriteService', () => {
    let service;
    let configService;
    beforeEach(() => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        // Mock globalRegistry.metrics()
        jest
            .spyOn(prom_client_1.register, 'metrics')
            .mockResolvedValue('# HELP visapi_test_metric Test metric\n# TYPE visapi_test_metric counter\nvisapi_test_metric 1');
        const module = yield testing_1.Test.createTestingModule({
            providers: [
                remote_write_service_1.RemoteWriteService,
                {
                    provide: config_1.ConfigService,
                    useValue: {
                        get: jest.fn((key, defaultValue) => {
                            var _a;
                            const config = {
                                GRAFANA_REMOTE_WRITE_ENABLED: true,
                                GRAFANA_PROMETHEUS_URL: 'https://prometheus.grafana.net/api/prom/push',
                                GRAFANA_PROMETHEUS_USERNAME: '123456',
                                GRAFANA_PROMETHEUS_PASSWORD: 'test-api-key',
                                GRAFANA_PUSH_INTERVAL_MS: 1000, // 1 second for testing
                            };
                            return (_a = config[key]) !== null && _a !== void 0 ? _a : defaultValue;
                        }),
                    },
                },
            ],
        }).compile();
        service = module.get(remote_write_service_1.RemoteWriteService);
        configService = module.get(config_1.ConfigService);
    }));
    afterEach(() => {
        jest.clearAllMocks();
        if (service['intervalId']) {
            clearInterval(service['intervalId']);
        }
        mockPushTimeseries.mockReset();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    it('should not start pushing when disabled', () => {
        jest
            .spyOn(configService, 'get')
            .mockImplementation((key, defaultValue) => {
            if (key === 'GRAFANA_REMOTE_WRITE_ENABLED')
                return false;
            return defaultValue;
        });
        const newService = new remote_write_service_1.RemoteWriteService(configService);
        newService.onModuleInit();
        expect(newService['intervalId']).toBeUndefined();
    });
    it('should not start pushing when credentials are missing', () => {
        jest
            .spyOn(configService, 'get')
            .mockImplementation((key, defaultValue) => {
            if (key === 'GRAFANA_REMOTE_WRITE_ENABLED')
                return true;
            if (key === 'GRAFANA_PROMETHEUS_URL')
                return undefined;
            return defaultValue;
        });
        const newService = new remote_write_service_1.RemoteWriteService(configService);
        newService.onModuleInit();
        expect(newService['intervalId']).toBeUndefined();
    });
    it('should start pushing metrics when enabled with valid credentials', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        mockPushTimeseries.mockResolvedValueOnce({ status: 200, statusText: 'OK' });
        service.onModuleInit();
        expect(service['intervalId']).toBeDefined();
        // Wait for the initial push to complete
        yield new Promise((resolve) => setTimeout(resolve, 100));
        expect(mockPushTimeseries).toHaveBeenCalledWith(expect.any(Array), expect.objectContaining({
            url: 'https://prometheus.grafana.net/api/prom/push',
            auth: {
                username: '123456',
                password: 'test-api-key',
            },
            timeout: 10000,
            headers: {
                'User-Agent': 'visapi-remote-write/1.0',
            },
        }));
    }));
    it('should handle push errors gracefully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        mockPushTimeseries.mockRejectedValueOnce(new Error('Network error'));
        const loggerSpy = jest.spyOn(service['logger'], 'error');
        yield service['pushMetrics']();
        expect(loggerSpy).toHaveBeenCalledWith('Failed to push metrics to Grafana Cloud', 'Network error');
    }));
    it('should stop pushing on module destroy', () => {
        service.onModuleInit();
        const intervalId = service['intervalId'];
        expect(intervalId).toBeDefined();
        service.onModuleDestroy();
        expect(service['intervalId']).toBe(intervalId); // Same reference, but cleared
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3ZhZGltL1Byb2plY3RzL1Zpc0FQSS9hcHBzL2JhY2tlbmQvc3JjL21ldHJpY3MvcmVtb3RlLXdyaXRlLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7QUFNQSxJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDMUMsY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDMUIsQ0FBQyxDQUFDLENBQUM7QUFSSiw2Q0FBc0Q7QUFDdEQsMkNBQStDO0FBQy9DLGlFQUE0RDtBQUM1RCw2Q0FBeUQ7QUFDekQscUVBQXlEO0FBTXpELE1BQU0sa0JBQWtCLEdBQUcsd0NBRTFCLENBQUM7QUFFRixRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLElBQUksT0FBMkIsQ0FBQztJQUNoQyxJQUFJLGFBQTRCLENBQUM7SUFFakMsVUFBVSxDQUFDLEdBQVMsRUFBRTtRQUNwQixnQ0FBZ0M7UUFDaEMsSUFBSTthQUNELEtBQUssQ0FBQyxzQkFBYyxFQUFFLFNBQVMsQ0FBQzthQUNoQyxpQkFBaUIsQ0FDaEIsZ0dBQWdHLENBQ2pHLENBQUM7UUFFSixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULHlDQUFrQjtnQkFDbEI7b0JBQ0UsT0FBTyxFQUFFLHNCQUFhO29CQUN0QixRQUFRLEVBQUU7d0JBQ1IsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFXLEVBQUUsWUFBa0IsRUFBRSxFQUFFOzs0QkFDL0MsTUFBTSxNQUFNLEdBQUc7Z0NBQ2IsNEJBQTRCLEVBQUUsSUFBSTtnQ0FDbEMsc0JBQXNCLEVBQ3BCLDhDQUE4QztnQ0FDaEQsMkJBQTJCLEVBQUUsUUFBUTtnQ0FDckMsMkJBQTJCLEVBQUUsY0FBYztnQ0FDM0Msd0JBQXdCLEVBQUUsSUFBSSxFQUFFLHVCQUF1Qjs2QkFDeEQsQ0FBQzs0QkFDRixPQUFPLE1BQUEs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RUFBRSw4Q0FBOEM7WUFDbkQsSUFBSSxFQUFFO2dCQUNKLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixRQUFRLEVBQUUsY0FBYzthQUN6QjtZQUNELE9BQU8sRUFBRSxLQUFLO1lBQ2QsT0FBTyxFQUFFO2dCQUNQLFlBQVksRUFBRSx5QkFBeUI7YUFDeEM7U0FDRixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBUyxFQUFFO1FBQ3BELGtCQUFrQixDQUFDLHFCQUFxQixDQUFDLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDckUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFekQsTUFBTSxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztRQUUvQixNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsb0JBQW9CLENBQ3BDLHlDQUF5QyxFQUN6QyxlQUFlLENBQ2hCLENBQUM7SUFDSixDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLHVDQUF1QyxFQUFFLEdBQUcsRUFBRTtRQUMvQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVqQyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDMUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLDhCQUE4QjtJQUNoRixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy92YWRpbS9Qcm9qZWN0cy9WaXNBUEkvYXBwcy9iYWNrZW5kL3NyYy9tZXRyaWNzL3JlbW90ZS13cml0ZS5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgUmVtb3RlV3JpdGVTZXJ2aWNlIH0gZnJvbSAnLi9yZW1vdGUtd3JpdGUuc2VydmljZSc7XG5pbXBvcnQgeyByZWdpc3RlciBhcyBnbG9iYWxSZWdpc3RyeSB9IGZyb20gJ3Byb20tY2xpZW50JztcbmltcG9ydCB7IHB1c2hUaW1lc2VyaWVzIH0gZnJvbSAncHJvbWV0aGV1cy1yZW1vdGUtd3JpdGUnO1xuXG5qZXN0Lm1vY2soJ3Byb21ldGhldXMtcmVtb3RlLXdyaXRlJywgKCkgPT4gKHtcbiAgcHVzaFRpbWVzZXJpZXM6IGplc3QuZm4oKSxcbn0pKTtcblxuY29uc3QgbW9ja1B1c2hUaW1lc2VyaWVzID0gcHVzaFRpbWVzZXJpZXMgYXMgamVzdC5Nb2NrZWRGdW5jdGlvbjxcbiAgdHlwZW9mIHB1c2hUaW1lc2VyaWVzXG4+O1xuXG5kZXNjcmliZSgnUmVtb3RlV3JpdGVTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUmVtb3RlV3JpdGVTZXJ2aWNlO1xuICBsZXQgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBNb2NrIGdsb2JhbFJlZ2lzdHJ5Lm1ldHJpY3MoKVxuICAgIGplc3RcbiAgICAgIC5zcHlPbihnbG9iYWxSZWdpc3RyeSwgJ21ldHJpY3MnKVxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKFxuICAgICAgICAnIyBIRUxQIHZpc2FwaV90ZXN0X21ldHJpYyBUZXN0IG1ldHJpY1xcbiMgVFlQRSB2aXNhcGlfdGVzdF9tZXRyaWMgY291bnRlclxcbnZpc2FwaV90ZXN0X21ldHJpYyAxJ1xuICAgICAgKTtcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgUmVtb3RlV3JpdGVTZXJ2aWNlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZ2V0OiBqZXN0LmZuKChrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlPzogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgICAgICAgICBHUkFGQU5BX1JFTU9URV9XUklURV9FTkFCTEVEOiB0cnVlLFxuICAgICAgICAgICAgICAgIEdSQUZBTkFfUFJPTUVUSEVVU19VUkw6XG4gICAgICAgICAgICAgICAgICAnaHR0cHM6Ly9wcm9tZXRoZXVzLmdyYWZhbmEubmV0L2FwaS9wcm9tL3B1c2gnLFxuICAgICAgICAgICAgICAgIEdSQUZBTkFfUFJPTUVUSEVVU19VU0VSTkFNRTogJzEyMzQ1NicsXG4gICAgICAgICAgICAgICAgR1JBRkFOQV9QUk9NRVRIRVVTX1BBU1NXT1JEOiAndGVzdC1hcGkta2V5JyxcbiAgICAgICAgICAgICAgICBHUkFGQU5BX1BVU0hfSU5URVJWQUxfTVM6IDEwMDAsIC8vIDEgc2Vjb25kIGZvciB0ZXN0aW5nXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIHJldHVybiBjb25maWdba2V5XSA/PyBkZWZhdWx0VmFsdWU7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxSZW1vdGVXcml0ZVNlcnZpY2U+KFJlbW90ZVdyaXRlU2VydmljZSk7XG4gICAgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8Q29uZmlnU2VydmljZT4oQ29uZmlnU2VydmljZSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgaWYgKHNlcnZpY2VbJ2ludGVydmFsSWQnXSkge1xuICAgICAgY2xlYXJJbnRlcnZhbChzZXJ2aWNlWydpbnRlcnZhbElkJ10pO1xuICAgIH1cbiAgICBtb2NrUHVzaFRpbWVzZXJpZXMubW9ja1Jlc2V0KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBub3Qgc3RhcnQgcHVzaGluZyB3aGVuIGRpc2FibGVkJywgKCkgPT4ge1xuICAgIGplc3RcbiAgICAgIC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JylcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ0dSQUZBTkFfUkVNT1RFX1dSSVRFX0VOQUJMRUQnKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgICB9KTtcblxuICAgIGNvbnN0IG5ld1NlcnZpY2UgPSBuZXcgUmVtb3RlV3JpdGVTZXJ2aWNlKGNvbmZpZ1NlcnZpY2UpO1xuICAgIG5ld1NlcnZpY2Uub25Nb2R1bGVJbml0KCk7XG5cbiAgICBleHBlY3QobmV3U2VydmljZVsnaW50ZXJ2YWxJZCddKS50b0JlVW5kZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbm90IHN0YXJ0IHB1c2hpbmcgd2hlbiBjcmVkZW50aWFscyBhcmUgbWlzc2luZycsICgpID0+IHtcbiAgICBqZXN0XG4gICAgICAuc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlPzogYW55KSA9PiB7XG4gICAgICAgIGlmIChrZXkgPT09ICdHUkFGQU5BX1JFTU9URV9XUklURV9FTkFCTEVEJykgcmV0dXJuIHRydWU7XG4gICAgICAgIGlmIChrZXkgPT09ICdHUkFGQU5BX1BST01FVEhFVVNfVVJMJykgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgbmV3U2VydmljZSA9IG5ldyBSZW1vdGVXcml0ZVNlcnZpY2UoY29uZmlnU2VydmljZSk7XG4gICAgbmV3U2VydmljZS5vbk1vZHVsZUluaXQoKTtcblxuICAgIGV4cGVjdChuZXdTZXJ2aWNlWydpbnRlcnZhbElkJ10pLnRvQmVVbmRlZmluZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBzdGFydCBwdXNoaW5nIG1ldHJpY3Mgd2hlbiBlbmFibGVkIHdpdGggdmFsaWQgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbW9ja1B1c2hUaW1lc2VyaWVzLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7IHN0YXR1czogMjAwLCBzdGF0dXNUZXh0OiAnT0snIH0pO1xuXG4gICAgc2VydmljZS5vbk1vZHVsZUluaXQoKTtcblxuICAgIGV4cGVjdChzZXJ2aWNlWydpbnRlcnZhbElkJ10pLnRvQmVEZWZpbmVkKCk7XG5cbiAgICAvLyBXYWl0IGZvciB0aGUgaW5pdGlhbCBwdXNoIHRvIGNvbXBsZXRlXG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG5cbiAgICBleHBlY3QobW9ja1B1c2hUaW1lc2VyaWVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgIGV4cGVjdC5hbnkoQXJyYXkpLFxuICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICB1cmw6ICdodHRwczovL3Byb21ldGhldXMuZ3JhZmFuYS5uZXQvYXBpL3Byb20vcHVzaCcsXG4gICAgICAgIGF1dGg6IHtcbiAgICAgICAgICB1c2VybmFtZTogJzEyMzQ1NicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICd0ZXN0LWFwaS1rZXknLFxuICAgICAgICB9LFxuICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdVc2VyLUFnZW50JzogJ3Zpc2FwaS1yZW1vdGUtd3JpdGUvMS4wJyxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgcHVzaCBlcnJvcnMgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICBtb2NrUHVzaFRpbWVzZXJpZXMubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignTmV0d29yayBlcnJvcicpKTtcbiAgICBjb25zdCBsb2dnZXJTcHkgPSBqZXN0LnNweU9uKHNlcnZpY2VbJ2xvZ2dlciddLCAnZXJyb3InKTtcblxuICAgIGF3YWl0IHNlcnZpY2VbJ3B1c2hNZXRyaWNzJ10oKTtcblxuICAgIGV4cGVjdChsb2dnZXJTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgJ0ZhaWxlZCB0byBwdXNoIG1ldHJpY3MgdG8gR3JhZmFuYSBDbG91ZCcsXG4gICAgICAnTmV0d29yayBlcnJvcidcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHN0b3AgcHVzaGluZyBvbiBtb2R1bGUgZGVzdHJveScsICgpID0+IHtcbiAgICBzZXJ2aWNlLm9uTW9kdWxlSW5pdCgpO1xuICAgIGNvbnN0IGludGVydmFsSWQgPSBzZXJ2aWNlWydpbnRlcnZhbElkJ107XG4gICAgZXhwZWN0KGludGVydmFsSWQpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICBzZXJ2aWNlLm9uTW9kdWxlRGVzdHJveSgpO1xuICAgIGV4cGVjdChzZXJ2aWNlWydpbnRlcnZhbElkJ10pLnRvQmUoaW50ZXJ2YWxJZCk7IC8vIFNhbWUgcmVmZXJlbmNlLCBidXQgY2xlYXJlZFxuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9