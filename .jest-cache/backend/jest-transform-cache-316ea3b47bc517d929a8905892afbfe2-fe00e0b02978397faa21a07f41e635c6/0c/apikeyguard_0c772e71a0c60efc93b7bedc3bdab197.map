{"file":"/Users/vadim/Projects/VisAPI/apps/backend/src/auth/guards/api-key.guard.ts","mappings":";;;;;AAAA,2CAKwB;AACxB,uCAAyC;AACzC,kDAA8C;AAC9C,qEAA4D;AAGrD,IAAM,WAAW,GAAjB,MAAM,WAAW;IACtB,YACmB,WAAwB,EACxB,SAAoB;QADpB,gBAAW,GAAX,WAAW,CAAa;QACxB,cAAS,GAAT,SAAS,CAAW;IACpC,CAAC;IAEE,WAAW,CAAC,OAAyB;;YACzC,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;YACpD,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YAE3C,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;YACzD,CAAC;YAED,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;YACnE,IAAI,CAAC,YAAY,EAAE,CAAC;gBAClB,MAAM,IAAI,8BAAqB,CAAC,4BAA4B,CAAC,CAAC;YAChE,CAAC;YAED,4BAA4B;YAC5B,MAAM,cAAc,GAClB,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAW,6BAAU,EAAE;gBACrD,OAAO,CAAC,UAAU,EAAE;gBACpB,OAAO,CAAC,QAAQ,EAAE;aACnB,CAAC,IAAI,EAAE,CAAC;YAEX,IAAI,cAAc,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC9B,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,WAAW,CAClD,YAAY,EACZ,cAAc,CACf,CAAC;gBAEF,IAAI,CAAC,SAAS,EAAE,CAAC;oBACf,MAAM,IAAI,8BAAqB,CAC7B,8CAA8C,cAAc,CAAC,IAAI,CAC/D,IAAI,CACL,EAAE,CACJ,CAAC;gBACJ,CAAC;YACH,CAAC;YAED,0CAA0C;YAC1C,OAAO,CAAC,MAAM,GAAG,YAAY,CAAC;YAE9B,OAAO,IAAI,CAAC;QACd,CAAC;KAAA;IAEO,aAAa,CAAC,OAAY;QAChC,yBAAyB;QACzB,MAAM,MAAM,GAAG,OAAO,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC5C,IAAI,MAAM,EAAE,CAAC;YACX,OAAO,MAAM,CAAC;QAChB,CAAC;QAED,mCAAmC;QACnC,MAAM,UAAU,GAAG,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC;QACjD,IAAI,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;YACtC,OAAO,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QACjC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AA9DY,kCAAW;sBAAX,WAAW;IADvB,IAAA,mBAAU,GAAE;iEAGqB,0BAAW,oBAAX,0BAAW,oDACb,gBAAS,oBAAT,gBAAS;GAH5B,WAAW,CA8DvB","names":[],"sources":["/Users/vadim/Projects/VisAPI/apps/backend/src/auth/guards/api-key.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { AuthService } from '../auth.service';\nimport { SCOPES_KEY } from '../decorators/scopes.decorator';\n\n@Injectable()\nexport class ApiKeyGuard implements CanActivate {\n  constructor(\n    private readonly authService: AuthService,\n    private readonly reflector: Reflector\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const apiKey = this.extractApiKey(request);\n\n    if (!apiKey) {\n      throw new UnauthorizedException('API key is required');\n    }\n\n    const validatedKey = await this.authService.validateApiKey(apiKey);\n    if (!validatedKey) {\n      throw new UnauthorizedException('Invalid or expired API key');\n    }\n\n    // Check scopes if specified\n    const requiredScopes =\n      this.reflector.getAllAndOverride<string[]>(SCOPES_KEY, [\n        context.getHandler(),\n        context.getClass(),\n      ]) || [];\n\n    if (requiredScopes.length > 0) {\n      const hasScopes = await this.authService.checkScopes(\n        validatedKey,\n        requiredScopes\n      );\n\n      if (!hasScopes) {\n        throw new UnauthorizedException(\n          `Insufficient permissions. Required scopes: ${requiredScopes.join(\n            ', '\n          )}`\n        );\n      }\n    }\n\n    // Attach the validated key to the request\n    request.apiKey = validatedKey;\n\n    return true;\n  }\n\n  private extractApiKey(request: any): string | null {\n    // Check X-API-Key header\n    const apiKey = request.headers['x-api-key'];\n    if (apiKey) {\n      return apiKey;\n    }\n\n    // Check Authorization Bearer token\n    const authHeader = request.headers.authorization;\n    if (authHeader?.startsWith('Bearer ')) {\n      return authHeader.substring(7);\n    }\n\n    return null;\n  }\n}\n"],"version":3}